<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - Excel Y√ºkleme</title>
    <link rel="stylesheet" href="style.css"> <style>
        /* Mevcut CSS dosyalarƒ±nƒ±zdaki header, main-container, form-container gibi ortak stilleri buraya ta≈üƒ±yabilirsiniz veya ayrƒ± bir CSS dosyasƒ± olu≈üturabilirsiniz. */
        /* √ñrnek olarak, data-entry.html'den bazƒ± stilleri kopyaladƒ±m */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: #1e3c72;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
        }

        .breadcrumb a {
            color: #1e3c72;
            text-decoration: none;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .main-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .page-header-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 2em;
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .notification-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-message.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .notification-message.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .notification-message.info {
            background: #cce5ff;
            color: #004085;
            border-left: 4px solid #007bff;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #1e3c72;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }

        .file-upload-area {
            border: 2px dashed #e1e8ed;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: #1e3c72;
            background: #f8f9fa;
        }

        .upload-icon {
            font-size: 3em;
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .preview-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            margin-top: 20px;
            display: none; /* Varsayƒ±lan olarak gizli */
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .preview-table th, .preview-table td {
            padding: 10px 15px;
            border: 1px solid #e1e8ed;
            text-align: left;
            white-space: nowrap; /* S√ºtun geni≈üliƒüini korumak i√ßin */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .preview-table tbody tr:nth-child(even) {
            background: #fcfcfc;
        }

        .preview-table tbody tr:hover {
            background: #f0f4f8;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e1e8ed;
            justify-content: flex-end;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(30, 60, 114, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .column-mapping-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e1e8ed;
        }

        .column-mapping-section h3 {
            font-size: 1.2em;
            color: #1e3c72;
            margin-bottom: 20px;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .mapping-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .mapping-label {
            font-weight: 500;
            color: #333;
            font-size: 0.95em;
        }

        .mapping-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 0.9em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .column-mapping-section .mapping-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">IP Manager</div>
            <div class="breadcrumb">
                <a href="dashboard.html">Dashboard</a>
                <span>></span>
                <a href="portfolio.html">Portf√∂y</a>
                <span>></span>
                <span>Excel Y√ºkleme</span>
            </div>
            <button class="back-btn" id="backBtn">
                ‚Üê Geri D√∂n
            </button>
        </div>
    </header>

    <main class="main-container">
        <div class="page-header-section">
            <h1 class="page-title">Excel Veri Y√ºkleme</h1>
            <p class="page-subtitle">Excel dosyanƒ±zdaki fikri m√ºlkiyet kayƒ±tlarƒ±nƒ± toplu olarak sisteme aktarƒ±n.</p>
        </div>

        <div class="form-container">
            <div class="notification-message success" id="successMessage" style="display: none;">
                <span>‚úÖ</span>
                <span id="successText">Veriler ba≈üarƒ±yla y√ºklendi!</span>
            </div>
            <div class="notification-message error" id="errorMessage" style="display: none;">
                <span>‚ùå</span>
                <span id="errorText">Bir hata olu≈ütu. L√ºtfen tekrar deneyin.</span>
            </div>
            <div class="notification-message info" id="infoMessage" style="display: none;">
                <span>‚ÑπÔ∏è</span>
                <span id="infoText"></span>
            </div>

            <form id="excelUploadForm">
                <div class="form-group">
                    <label class="form-label" for="excelFile">1. Excel Dosyasƒ±nƒ± Se√ßin <span style="color:red;">*</span></label>
                    <div class="file-upload-area" id="fileUploadArea">
                        <div class="upload-icon">üìÑ</div>
                        <div>Dosyayƒ± buraya s√ºr√ºkleyin veya tƒ±klayƒ±n</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">Sadece .xlsx veya .xls uzantƒ±lƒ± dosyalar.</div>
                        <input type="file" id="excelFile" hidden accept=".xlsx, .xls">
                    </div>
                </div>

                <div class="form-group" id="sheetSelectionGroup" style="display: none;">
                    <label class="form-label" for="sheetName">2. Hangi Sayfayƒ± Y√ºkleyeceksiniz?</label>
                    <select id="sheetName" class="form-select"></select>
                </div>

                <div class="form-group" id="headerRowGroup" style="display: none;">
                    <label class="form-label">3. ƒ∞lk Satƒ±r Ba≈ülƒ±k Satƒ±rƒ± Mƒ±?</label>
                    <input type="checkbox" id="hasHeader" checked> Evet, ilk satƒ±r s√ºtun ba≈ülƒ±klarƒ±nƒ± i√ßeriyor.
                </div>

                <div class="preview-table-container" id="previewTableContainer">
                    <table class="preview-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="column-mapping-section" id="columnMappingSection" style="display: none;">
                    <h3>4. S√ºtun E≈üle≈ütirme (Zorunlu Alanlar)</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                        Veritabanƒ± alanlarƒ±nƒ± Excel s√ºtunlarƒ±nƒ±zla e≈üle≈ütirin.
                    </p>
                    <div class="mapping-grid">
                        <div class="mapping-item">
                            <label class="mapping-label">IP T√ºr√º <span style="color:red;">*</span></label>
                            <select class="mapping-select required-mapping" data-db-field="type"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Ba≈ülƒ±k/Ad <span style="color:red;">*</span></label>
                            <select class="mapping-select required-mapping" data-db-field="title"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Durum <span style="color:red;">*</span></label>
                            <select class="mapping-select required-mapping" data-db-field="status"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Ba≈üvuru Tarihi <span style="color:red;">*</span></label>
                            <select class="mapping-select required-mapping" data-db-field="applicationDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">A√ßƒ±klama <span style="color:red;">*</span></label>
                            <select class="mapping-select required-mapping" data-db-field="description"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Hak Sahipleri (ƒ∞simler) <span style="color:red;">*</span></label>
                            <select class="mapping-select required-mapping" data-db-field="owners"></select>
                            <small style="font-size:0.8em; color:#888;">Birden fazla ise virg√ºl ile ayƒ±rƒ±n.</small>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Ba≈üvuru Numarasƒ±</label>
                            <select class="mapping-select" data-db-field="applicationNumber"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Tescil Numarasƒ±</label>
                            <select class="mapping-select" data-db-field="registrationNumber"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Yenileme Tarihi</label>
                            <select class="mapping-select" data-db-field="renewalDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">B√ºlten Tarihi</label>
                            <select class="mapping-select" data-db-field="bulletinDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">B√ºlten Numarasƒ±</label>
                            <select class="mapping-select" data-db-field="bulletinNumber"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Patent Sƒ±nƒ±fƒ±</label>
                            <select class="mapping-select" data-db-field="patentClass"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Son Ge√ßerlilik Tarihi</label>
                            <select class="mapping-select" data-db-field="expiryDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">√ñncelik Tarihi</label>
                            <select class="mapping-select" data-db-field="priority"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Patent ƒ∞stekleri</label>
                            <select class="mapping-select" data-db-field="claims"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Marka T√ºr√º</label>
                            <select class="mapping-select" data-db-field="trademarkType"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Nice Sƒ±nƒ±fƒ±</label>
                            <select class="mapping-select" data-db-field="niceClass"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Mal ve Hizmetler</label>
                            <select class="mapping-select" data-db-field="goodsServices"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Eser T√ºr√º</label>
                            <select class="mapping-select" data-db-field="workType"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Eser Olu≈üturma Tarihi</label>
                            <select class="mapping-select" data-db-field="creationDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Yayƒ±n Tarihi</label>
                            <select class="mapping-select" data-db-field="publicationDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Yayƒ±nevi/Yapƒ±mcƒ±</label>
                            <select class="mapping-select" data-db-field="publisher"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Tasarƒ±m T√ºr√º</label>
                            <select class="mapping-select" data-db-field="designType"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Locarno Sƒ±nƒ±fƒ±</label>
                            <select class="mapping-select" data-db-field="locarnoClass"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Tasarƒ±m Tarihi</label>
                            <select class="mapping-select" data-db-field="designDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Tasarƒ±m √ñzellikleri</label>
                            <select class="mapping-select" data-db-field="designFeatures"></select>
                        </div>

                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelUploadBtn">
                        ƒ∞ptal
                    </button>
                    <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
                        <span id="uploadText">Verileri Y√ºkle</span>
                        <span class="loading-spinner" id="uploadLoading" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script type="module">
        import { authService, ipRecordsService, personsService, auth } from './firebase-config.js';

        class ExcelUploadModule {
            constructor() {
                this.selectedFile = null;
                this.workbook = null;
                this.dataRows = []; // Excel'den okunan ham veri
                this.columnHeaders = []; // Excel'den okunan s√ºtun ba≈ülƒ±klarƒ±
                this.currentUser = null;
                this.allPersons = []; // Hak sahiplerini e≈üle≈ütirmek i√ßin t√ºm ki≈üiler
                this.init();
            }

            init() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        this.currentUser = authService.getCurrentUser();
                        console.log('‚úÖ User authenticated for Excel Upload:', this.currentUser.email, 'Role:', this.currentUser.role);
                        await this.loadAllPersons(); // Ki≈üileri y√ºkle
                        this.initializeEventListeners();
                    } else {
                        const localUser = authService.getCurrentUser();
                        if (localUser && localUser.uid) {
                            this.currentUser = localUser;
                            console.log('‚ö†Ô∏è LocalStorage user detected for Excel Upload, running in local mode:', this.currentUser.email, 'Role:', this.currentUser.role);
                            await this.loadAllPersons(); // Ki≈üileri y√ºkle
                            this.initializeEventListeners();
                        } else {
                            console.log('‚ùå User not authenticated, redirecting to login page.');
                            window.location.href = 'index.html';
                        }
                    }
                });
                console.log('üì§ Excel Y√ºkleme Mod√ºl√º ba≈ülatƒ±lƒ±yor...');
            }

            async loadAllPersons() {
                try {
                    const result = await personsService.getPersons();
                    if (result.success) {
                        this.allPersons = result.data;
                        console.log('üë• All persons loaded for mapping:', this.allPersons.length);
                    } else {
                        console.error('Failed to load all persons for Excel upload:', result.error);
                        this.showNotification('Ki≈üiler y√ºklenirken bir hata olu≈ütu: ' + (result.error || 'Bilinmeyen Hata'), 'error');
                    }
                } catch (error) {
                    console.error('Error in loadAllPersons:', error);
                    this.showNotification('Ki≈üiler y√ºklenirken aƒü hatasƒ± olu≈ütu.', 'error');
                }
            }

            initializeEventListeners() {
                document.getElementById('backBtn').addEventListener('click', () => {
                    if (confirm('Deƒüi≈üiklikler kaybolacak. Devam etmek istiyor musunuz?')) {
                        window.location.href = 'portfolio.html';
                    }
                });

                const fileUploadArea = document.getElementById('fileUploadArea');
                const excelFileInput = document.getElementById('excelFile');

                fileUploadArea.addEventListener('click', () => excelFileInput.click());
                excelFileInput.addEventListener('change', (e) => this.handleFile(e.target.files[0]));

                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.style.borderColor = '#1e3c72';
                    fileUploadArea.style.background = '#f0f4f8';
                });
                fileUploadArea.addEventListener('dragleave', () => {
                    fileUploadArea.style.borderColor = '#e1e8ed';
                    fileUploadArea.style.background = 'transparent';
                });
                fileUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUploadArea.style.borderColor = '#e1e8ed';
                    fileUploadArea.style.background = 'transparent';
                    this.handleFile(e.dataTransfer.files[0]);
                });

                document.getElementById('sheetName').addEventListener('change', () => this.readSelectedSheet());
                document.getElementById('hasHeader').addEventListener('change', () => this.readSelectedSheet());

                document.getElementById('uploadBtn').addEventListener('click', () => this.uploadDataToDatabase());
                document.getElementById('cancelUploadBtn').addEventListener('click', () => this.resetForm());
            }

            showNotification(message, type = 'info') {
                const successDiv = document.getElementById('successMessage');
                const errorDiv = document.getElementById('errorMessage');
                const infoDiv = document.getElementById('infoMessage');

                successDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                infoDiv.style.display = 'none';

                let targetDiv;
                if (type === 'success') {
                    targetDiv = successDiv;
                    document.getElementById('successText').textContent = message;
                } else if (type === 'error') {
                    targetDiv = errorDiv;
                    document.getElementById('errorText').textContent = message;
                } else {
                    targetDiv = infoDiv;
                    document.getElementById('infoText').textContent = message;
                }

                targetDiv.style.display = 'flex';
                
                // Belirli bir s√ºre sonra mesajƒ± otomatik gizle (isteƒüe baƒülƒ±)
                if (type !== 'error') { // Hata mesajlarƒ± kalƒ±cƒ± olabilir
                    setTimeout(() => {
                        targetDiv.style.display = 'none';
                    }, 5000);
                }
            }

            setLoading(isLoading) {
                const uploadBtn = document.getElementById('uploadBtn');
                const uploadText = document.getElementById('uploadText');
                const uploadLoading = document.getElementById('uploadLoading');

                uploadBtn.disabled = isLoading;
                uploadText.style.display = isLoading ? 'none' : 'inline';
                uploadLoading.style.display = isLoading ? 'inline-block' : 'none';
            }

            async handleFile(file) {
                if (!file) {
                    this.resetForm(); // Dosya se√ßilmezse formu sƒ±fƒ±rla
                    return;
                }

                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (!['xlsx', 'xls'].includes(fileExtension)) {
                    this.showNotification('L√ºtfen ge√ßerli bir Excel dosyasƒ± (.xlsx veya .xls) se√ßin.', 'error');
                    this.resetForm();
                    return;
                }

                this.selectedFile = file;
                this.showNotification(`Dosya se√ßildi: ${file.name}. Okunuyor...`, 'info');
                this.setLoading(true);
                document.getElementById('uploadBtn').disabled = true; // Y√ºkleme butonunu ba≈ülangƒ±√ßta devre dƒ±≈üƒ± bƒ±rak

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        this.workbook = XLSX.read(data, { type: 'array' });
                        this.populateSheetDropdown();
                        document.getElementById('sheetSelectionGroup').style.display = 'block';
                        document.getElementById('headerRowGroup').style.display = 'block'; // Doƒüru ID kullanƒ±ldƒ±

                        this.readSelectedSheet(); // ƒ∞lk sayfayƒ± otomatik oku
                        this.setLoading(false);
                    } catch (error) {
                        console.error('Excel dosyasƒ± i≈ülenirken hata:', error);
                        this.showNotification('Excel dosyasƒ± i≈ülenirken bir hata olu≈ütu. Dosya bozuk veya format hatasƒ± olabilir.', 'error');
                        this.resetForm();
                        this.setLoading(false);
                    }
                };
                reader.onerror = (error) => {
                    console.error('Dosya okuma hatasƒ±:', error);
                    this.showNotification('Dosya okunamadƒ±. L√ºtfen tekrar deneyin.', 'error');
                    this.resetForm();
                    this.setLoading(false);
                };
                reader.readAsArrayBuffer(file);
            }

            populateSheetDropdown() {
                const sheetSelect = document.getElementById('sheetName');
                sheetSelect.innerHTML = '';
                this.workbook.SheetNames.forEach(sheetName => {
                    const option = document.createElement('option');
                    option.value = sheetName;
                    option.textContent = sheetName;
                    sheetSelect.appendChild(option);
                });
            }

            readSelectedSheet() {
                if (!this.workbook) return;

                const sheetName = document.getElementById('sheetName').value;
                const hasHeader = document.getElementById('hasHeader').checked;

                const worksheet = this.workbook.Sheets[sheetName];
                // veriyi JSON formatƒ±na d√∂n√º≈üt√ºr
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (jsonData.length === 0) {
                    this.showNotification('Se√ßilen sayfada veri bulunamadƒ±.', 'info');
                    document.getElementById('previewTableContainer').style.display = 'none';
                    document.getElementById('columnMappingSection').style.display = 'none';
                    document.getElementById('uploadBtn').disabled = true;
                    this.dataRows = [];
                    this.columnHeaders = [];
                    return;
                }

                this.dataRows = jsonData;
                if (hasHeader) {
                    this.columnHeaders = this.dataRows.shift(); // ƒ∞lk satƒ±rƒ± ba≈ülƒ±k olarak al
                } else {
                    this.columnHeaders = Array.from({ length: this.dataRows[0].length }, (_, i) => `S√ºtun ${i + 1}`);
                }

                this.renderPreviewTable();
                this.populateColumnMapping();
                document.getElementById('columnMappingSection').style.display = 'block';
                document.getElementById('uploadBtn').disabled = false; // Y√ºkleme butonunu etkinle≈ütir
            }

            renderPreviewTable() {
                const previewTableContainer = document.getElementById('previewTableContainer');
                const previewTable = previewTableContainer.querySelector('.preview-table');
                const thead = previewTable.querySelector('thead');
                const tbody = previewTable.querySelector('tbody');

                thead.innerHTML = '';
                tbody.innerHTML = '';

                // Ba≈ülƒ±k satƒ±rƒ±nƒ± olu≈ütur
                const headerRow = document.createElement('tr');
                this.columnHeaders.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    thead.appendChild(th);
                });
                thead.appendChild(headerRow);

                // Veri satƒ±rlarƒ±nƒ± olu≈ütur (ilk 10 satƒ±r √∂nizleme i√ßin)
                this.dataRows.slice(0, 10).forEach(row => {
                    const tr = document.createElement('tr');
                    row.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                previewTableContainer.style.display = 'block';
            }

            populateColumnMapping() {
                const mappingSelects = document.querySelectorAll('.column-mapping-section .mapping-select');
                
                mappingSelects.forEach(selectElement => {
                    selectElement.innerHTML = '<option value="">Se√ßiniz</option>'; // Varsayƒ±lan bo≈ü se√ßenek
                    this.columnHeaders.forEach(header => {
                        const option = document.createElement('option');
                        option.value = header;
                        option.textContent = header;
                        selectElement.appendChild(option);
                    });
                });
            }

            async uploadDataToDatabase() {
                this.setLoading(true);
                this.showNotification('Veriler veritabanƒ±na aktarƒ±lƒ±yor...', 'info');

                const mappedColumns = {};
                let isValidMapping = true;

                // Zorunlu alanlarƒ±n e≈üle≈ütirilmesini kontrol et
                document.querySelectorAll('.required-mapping').forEach(selectElement => {
                    const dbField = selectElement.dataset.dbField;
                    const selectedExcelColumn = selectElement.value;
                    if (!selectedExcelColumn) {
                        isValidMapping = false;
                        this.showNotification(`Zorunlu alan '${dbField}' i√ßin bir s√ºtun e≈üle≈ütirmesi se√ßmelisiniz.`, 'error');
                    }
                    mappedColumns[dbField] = selectedExcelColumn;
                });

                if (!isValidMapping) {
                    this.setLoading(false);
                    return;
                }

                const recordsToUpload = [];
                const headerRowIndex = this.columnHeaders.reduce((acc, header, index) => {
                    acc[header] = index;
                    return acc;
                }, {});

                for (const row of this.dataRows) {
                    const record = {};
                    for (const dbField in mappedColumns) {
                        const excelColumnName = mappedColumns[dbField];
                        const columnIndex = headerRowIndex[excelColumnName];
                        if (columnIndex !== undefined && row[columnIndex] !== undefined) {
                            record[dbField] = row[columnIndex];
                        } else {
                            record[dbField] = null; // E≈üle≈ümeyen veya bo≈ü h√ºcreler i√ßin null
                        }
                    }
                    
                    // Veri d√∂n√º≈ü√ºmleri ve doƒürulama
                    try {
                        const processedRecord = await this.processRecordForUpload(record);
                        if (processedRecord) {
                            recordsToUpload.push(processedRecord);
                        } else {
                            // Hatalƒ± satƒ±rƒ± atla veya kaydet
                            console.warn('Hatalƒ± satƒ±r atlandƒ±:', row);
                            // Sadece bilgi mesajƒ± g√∂ster, hata deƒüil, t√ºm satƒ±rlarƒ± engellemesin
                            this.showNotification(`Bazƒ± satƒ±rlar i≈ülenirken hata olu≈ütu ve atlandƒ±. Detaylar konsolda.`, 'info');
                        }
                    } catch (error) {
                        console.error('Kayƒ±t i≈ülenirken kritik hata:', row, error);
                        this.showNotification(`Bazƒ± satƒ±rlar i≈ülenirken kritik hata olu≈ütu ve atlandƒ±. Detaylar konsolda.`, 'error');
                    }
                }

                if (recordsToUpload.length === 0) {
                    this.showNotification('Hi√ß ge√ßerli kayƒ±t bulunamadƒ±. L√ºtfen Excel dosyanƒ±zƒ± kontrol edin.', 'error');
                    this.setLoading(false);
                    return;
                }

                let successCount = 0;
                let failCount = 0;

                for (const record of recordsToUpload) {
                    try {
                        const result = await ipRecordsService.addRecord(record);
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                            console.error('Tekil kayƒ±t eklenirken hata:', record, result.error);
                        }
                    } catch (error) {
                        failCount++;
                        console.error('Tekil kayƒ±t eklenirken beklenmeyen hata:', record, error);
                    }
                }

                if (successCount > 0) {
                    this.showNotification(`${successCount} kayƒ±t ba≈üarƒ±yla eklendi!`, 'success');
                }
                if (failCount > 0) {
                    this.showNotification(`${failCount} kayƒ±t eklenirken hata olu≈ütu.`, 'error');
                }
                if (successCount === 0 && failCount === 0) {
                    this.showNotification('Hi√ßbir kayƒ±t aktarƒ±lamadƒ±.', 'error');
                }

                this.setLoading(false);
                this.resetForm(); // ƒ∞≈ülem bittikten sonra formu sƒ±fƒ±rla
            }

            async processRecordForUpload(rawRecord) {
                const processedRecord = {};

                // IP T√ºr√º kontrol√º
                const ipTypeMap = {
                    "patent": "patent", "marka": "trademark", "telif hakkƒ±": "copyright", "tasarƒ±m": "design",
                    "patent ": "patent", "marka ": "trademark", "telif hakkƒ± ": "copyright", "tasarƒ±m ": "design",
                    // ƒ∞ngilizce kar≈üƒ±lƒ±klarƒ± da eklenebilir
                    "patent": "patent", "trademark": "trademark", "copyright": "copyright", "design": "design"
                };
                const rawType = String(rawRecord.type || '').toLowerCase().trim();
                processedRecord.type = ipTypeMap[rawType] || null;
                if (!processedRecord.type) {
                    this.showNotification(`Ge√ßersiz IP T√ºr√º: '${rawRecord.type}'. Satƒ±r atlandƒ±.`, 'info');
                    return null;
                }

                // Ba≈ülƒ±k
                processedRecord.title = String(rawRecord.title || '').trim();
                if (!processedRecord.title) {
                    this.showNotification(`Ba≈ülƒ±k bo≈ü. Satƒ±r atlandƒ±.`, 'info');
                    return null;
                }

                // Durum kontrol√º
                const statusMap = {
                    "ba≈üvuru": "application", "beklemede": "pending", "onaylandƒ±": "approved", "reddedildi": "rejected", "s√ºresi doldu": "expired",
                    "yayƒ±nlandƒ±": "published", "kƒ±smi ret": "partial_refusal", "ret": "refused", "itiraz geldi": "opposition_received",
                    "itiraz edildi": "opposition_filed", "tescilli": "registered", "yenilenmedi": "not_renewed",
                    "ba≈üvuru ge√ßersiz/h√ºk√ºms√ºz": "invalid_void",
                    // ƒ∞ngilizce kar≈üƒ±lƒ±klarƒ±
                    "application": "application", "pending": "pending", "approved": "approved", "rejected": "rejected", "expired": "expired",
                    "published": "published", "partial refusal": "partial_refusal", "refused": "refused", "opposition received": "opposition_received",
                    "opposition filed": "opposition_filed", "registered": "registered", "not renewed": "not_renewed",
                    "invalid/void": "invalid_void"
                };
                const rawStatus = String(rawRecord.status || '').toLowerCase().trim();
                processedRecord.status = statusMap[rawStatus] || 'pending'; // Varsayƒ±lan olarak 'beklemede'

                // Tarih d√∂n√º≈ü√ºmleri (√ñnemli: Excel tarihleri sayƒ± olarak gelebilir)
                processedRecord.applicationDate = this.excelDateToISO(rawRecord.applicationDate);
                if (!processedRecord.applicationDate) {
                    this.showNotification(`Ba≈üvuru Tarihi ge√ßersiz veya bo≈ü. Satƒ±r atlandƒ±.`, 'info');
                    return null;
                }

                // A√ßƒ±klama
                processedRecord.description = String(rawRecord.description || '').trim();
                if (!processedRecord.description) {
                    this.showNotification(`A√ßƒ±klama bo≈ü. Satƒ±r atlandƒ±.`, 'info');
                    return null;
                }

                // Hak Sahipleri - Excel'den gelen isimleri kullanarak var olan ki≈üileri bul
                processedRecord.owners = [];
                const rawOwners = String(rawRecord.owners || '').split(',').map(name => name.trim()).filter(name => name);
                for (const ownerName of rawOwners) {
                    const foundPerson = this.allPersons.find(p => p.name.toLowerCase() === ownerName.toLowerCase());
                    if (foundPerson) {
                        processedRecord.owners.push(foundPerson);
                    } else {
                        // Yeni ki≈üi olu≈üturma veya uyarƒ± verme
                        console.warn(`Hak sahibi bulunamadƒ±: '${ownerName}'. Yeni ki≈üi olarak eklenecek.`);
                        const newPerson = {
                            name: ownerName,
                            email: '', // Excel'de email/telefon yoksa bo≈ü bƒ±rak
                            phone: '',
                            type: 'individual', // Varsayƒ±lan olarak Bireysel
                            address: '',
                        };
                        try {
                            const addPersonResult = await personsService.addPerson(newPerson);
                            if (addPersonResult.success) {
                                processedRecord.owners.push({ id: addPersonResult.id, ...newPerson });
                                this.allPersons.push({ id: addPersonResult.id, ...newPerson }); // Yeni eklenen ki≈üiyi listeye ekle
                            } else {
                                console.error(`Yeni hak sahibi '${ownerName}' eklenemedi:`, addPersonResult.error);
                            }
                        } catch (e) {
                            console.error(`Yeni hak sahibi '${ownerName}' eklenirken hata:`, e);
                        }
                    }
                }
                if (processedRecord.owners.length === 0) {
                    this.showNotification(`Hak Sahibi bulunamadƒ± veya olu≈üturulamadƒ±. Satƒ±r atlandƒ±.`, 'info');
                    return null;
                }


                // Diƒüer isteƒüe baƒülƒ± alanlarƒ± ekle
                processedRecord.applicationNumber = String(rawRecord.applicationNumber || '').trim();
                processedRecord.registrationNumber = String(rawRecord.registrationNumber || '').trim();
                processedRecord.renewalDate = this.excelDateToISO(rawRecord.renewalDate);
                processedRecord.bulletinDate = this.excelDateToISO(rawRecord.bulletinDate);
                processedRecord.bulletinNumber = String(rawRecord.bulletinNumber || '').trim();
                processedRecord.patentClass = String(rawRecord.patentClass || '').trim();
                processedRecord.expiryDate = this.excelDateToISO(rawRecord.expiryDate);
                processedRecord.priority = this.excelDateToISO(rawRecord.priority);
                processedRecord.claims = String(rawRecord.claims || '').trim();
                processedRecord.trademarkType = String(rawRecord.trademarkType || '').trim();
                processedRecord.niceClass = String(rawRecord.niceClass || '').trim();
                processedRecord.goodsServices = String(rawRecord.goodsServices || '').trim();
                processedRecord.workType = String(rawRecord.workType || '').trim();
                processedRecord.creationDate = this.excelDateToISO(rawRecord.creationDate);
                processedRecord.publicationDate = this.excelDateToISO(rawRecord.publicationDate);
                processedRecord.publisher = String(rawRecord.publisher || '').trim();
                processedRecord.designType = String(rawRecord.designType || '').trim();
                processedRecord.locarnoClass = String(rawRecord.locarnoClass || '').trim();
                processedRecord.designDate = this.excelDateToISO(rawRecord.designDate);
                processedRecord.designFeatures = String(rawRecord.designFeatures || '').trim();

                // Ortak alanlar
                processedRecord.createdAt = new Date().toISOString();
                processedRecord.updatedAt = new Date().toISOString();
                processedRecord.userId = this.currentUser.uid;
                processedRecord.userEmail = this.currentUser.email;
                processedRecord.files = []; // Excel'den dosya y√ºkleme desteklenmiyorsa bo≈ü bƒ±rak

                return processedRecord;
            }

            excelDateToISO(excelDate) {
                if (typeof excelDate === 'number') {
                    // Excel'deki 0. g√ºn 30 Aralƒ±k 1899'dur. JavaScript tarihi 1 Ocak 1970'ten ba≈ülar.
                    const date = new Date(Date.UTC(0, 0, excelDate - 1)); // -1 √ß√ºnk√º Excel 1900'√º artƒ±k yƒ±l sanƒ±r.
                    return date.toISOString().split('T')[0];
                } else if (typeof excelDate === 'string' && excelDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    // Zaten YYYY-MM-DD formatƒ±nda ise direkt kullan
                    return excelDate;
                } else if (excelDate) {
                    // Diƒüer string formatlarƒ± i√ßin deneme
                    try {
                        const date = new Date(excelDate);
                        if (!isNaN(date.getTime())) {
                            return date.toISOString().split('T')[0];
                        }
                    } catch (e) {
                        console.warn('Tarih formatƒ± d√∂n√º≈üt√ºr√ºlemedi:', excelDate);
                    }
                }
                return null;
            }

            resetForm() {
                this.selectedFile = null;
                this.workbook = null;
                this.dataRows = [];
                this.columnHeaders = [];
                document.getElementById('excelFile').value = '';
                document.getElementById('sheetSelectionGroup').style.display = 'none';
                document.getElementById('hasHeader').checked = true;
                document.getElementById('headerRowGroup').style.display = 'none'; // Bunu da resetle
                document.getElementById('previewTableContainer').style.display = 'none';
                document.getElementById('columnMappingSection').style.display = 'none';
                document.getElementById('uploadBtn').disabled = true;
                document.getElementById('previewTableContainer').querySelector('thead').innerHTML = '';
                document.getElementById('previewTableContainer').querySelector('tbody').innerHTML = '';
                this.showNotification('Form sƒ±fƒ±rlandƒ±. Yeni bir dosya y√ºkleyebilirsiniz.', 'info');
                this.setLoading(false);
            }
        }

        let excelUploadModule;
        auth.onAuthStateChanged((user) => {
            if (!excelUploadModule) {
                excelUploadModule = new ExcelUploadModule();
            }
        });
    </script>
</body>
</html>