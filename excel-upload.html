<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - Excel Yükleme</title>
    <link rel="stylesheet" href="style.css"> <style>
        /* Mevcut CSS dosyalarınızdaki header, main-container, form-container gibi ortak stilleri buraya taşıyabilirsiniz veya ayrı bir CSS dosyası oluşturabilirsiniz. */
        /* Örnek olarak, data-entry.html'den bazı stilleri kopyaladım */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 0;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: #1e3c72;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
        }

        .breadcrumb a {
            color: #1e3c72;
            text-decoration: none;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .main-container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .page-header-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 2em;
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .form-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .notification-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification-message.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .notification-message.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .notification-message.info {
            background: #cce5ff;
            color: #004085;
            border-left: 4px solid #007bff;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #1e3c72;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }

        .file-upload-area {
            border: 2px dashed #e1e8ed;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: #1e3c72;
            background: #f8f9fa;
        }

        .upload-icon {
            font-size: 3em;
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .preview-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
            border-radius: 10px;
            margin-top: 20px;
            display: none; /* Varsayılan olarak gizli */
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .preview-table th, .preview-table td {
            padding: 10px 15px;
            border: 1px solid #e1e8ed;
            text-align: left;
            white-space: nowrap; /* Sütun genişliğini korumak için */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .preview-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .preview-table tbody tr:nth-child(even) {
            background: #fcfcfc;
        }

        .preview-table tbody tr:hover {
            background: #f0f4f8;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e1e8ed;
            justify-content: flex-end;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(30, 60, 114, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .column-mapping-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e1e8ed;
        }

        .column-mapping-section h3 {
            font-size: 1.2em;
            color: #1e3c72;
            margin-bottom: 20px;
        }

        .mapping-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .mapping-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .mapping-label {
            font-weight: 500;
            color: #333;
            font-size: 0.95em;
        }

        .mapping-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 0.9em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .form-actions {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
            .column-mapping-section .mapping-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">IP Manager</div>
            <div class="breadcrumb">
                <a href="dashboard.html">Dashboard</a>
                <span>></span>
                <a href="portfolio.html">Portföy</a>
                <span>></span>
                <span>Excel Yükleme</span>
            </div>
            <button class="back-btn" id="backBtn">
                ← Geri Dön
            </button>
        </div>
    </header>

    <main class="main-container">
        <div class="page-header-section">
            <h1 class="page-title">Excel Veri Yükleme</h1>
            <p class="page-subtitle">Excel dosyanızdaki fikri mülkiyet kayıtlarını toplu olarak sisteme aktarın.</p>
        </div>

        <div class="form-container">
            <div class="notification-message success" id="successMessage" style="display: none;">
                <span>✅</span>
                <span id="successText">Veriler başarıyla yüklendi!</span>
            </div>
            <div class="notification-message error" id="errorMessage" style="display: none;">
                <span>❌</span>
                <span id="errorText">Bir hata oluştu. Lütfen tekrar deneyin.</span>
            </div>
            <div class="notification-message info" id="infoMessage" style="display: none;">
                <span>ℹ️</span>
                <span id="infoText"></span>
            </div>

            <form id="excelUploadForm">
                <div class="form-group">
                    <label class="form-label" for="excelFile">1. Excel Dosyasını Seçin <span style="color:red;">*</span></label>
                    <div class="file-upload-area" id="fileUploadArea">
                        <div class="upload-icon">📄</div>
                        <div>Dosyayı buraya sürükleyin veya tıklayın</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">Sadece .xlsx veya .xls uzantılı dosyalar.</div>
                        <input type="file" id="excelFile" hidden accept=".xlsx, .xls">
                    </div>
                </div>

                <div class="form-group" id="sheetSelectionGroup" style="display: none;">
                    <label class="form-label" for="sheetName">2. Hangi Sayfayı Yükleyeceksiniz?</label>
                    <select id="sheetName" class="form-select"></select>
                </div>

                <div class="form-group" id="headerRowGroup" style="display: none;">
                    <label class="form-label">3. İlk Satır Başlık Satırı Mı?</label>
                    <input type="checkbox" id="hasHeader" checked> Evet, ilk satır sütun başlıklarını içeriyor.
                </div>

                <div class="preview-table-container" id="previewTableContainer">
                    <table class="preview-table">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="column-mapping-section" id="columnMappingSection" style="display: none;">
                    <h3>4. Sütun Eşleştirme (Zorunlu Alanlar)</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 20px;">
                        Veritabanı alanlarını Excel sütunlarınızla eşleştirin.
                    </p>
                    <div class="mapping-grid">
                        <div class="mapping-item">
                            <label class="mapping-label">IP Türü <span style="color:red;">*</span></label>
                            <select class="mapping-select required-mapping" data-db-field="type"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Başlık/Ad <span style="color:red;">*</span></label>
                            <select class="mapping-select required-mapping" data-db-field="title"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Durum <span style="color:red;">*</span></label>
                            <select class="mapping-select required-mapping" data-db-field="status"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Başvuru Tarihi <span style="color:red;">*</span></label>
                            <select class="mapping-select required-mapping" data-db-field="applicationDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Açıklama <span style="color:red;">*</span></label>
                            <select class="mapping-select required-mapping" data-db-field="description"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Hak Sahipleri (İsimler) <span style="color:red;">*</span></label>
                            <select class="mapping-select required-mapping" data-db-field="owners"></select>
                            <small style="font-size:0.8em; color:#888;">Birden fazla ise virgül ile ayırın.</small>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Başvuru Numarası</label>
                            <select class="mapping-select" data-db-field="applicationNumber"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Tescil Numarası</label>
                            <select class="mapping-select" data-db-field="registrationNumber"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Yenileme Tarihi</label>
                            <select class="mapping-select" data-db-field="renewalDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Bülten Tarihi</label>
                            <select class="mapping-select" data-db-field="bulletinDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Bülten Numarası</label>
                            <select class="mapping-select" data-db-field="bulletinNumber"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Patent Sınıfı</label>
                            <select class="mapping-select" data-db-field="patentClass"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Son Geçerlilik Tarihi</label>
                            <select class="mapping-select" data-db-field="expiryDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Öncelik Tarihi</label>
                            <select class="mapping-select" data-db-field="priority"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Patent İstekleri</label>
                            <select class="mapping-select" data-db-field="claims"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Marka Türü</label>
                            <select class="mapping-select" data-db-field="trademarkType"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Nice Sınıfı</label>
                            <select class="mapping-select" data-db-field="niceClass"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Mal ve Hizmetler</label>
                            <select class="mapping-select" data-db-field="goodsServices"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Eser Türü</label>
                            <select class="mapping-select" data-db-field="workType"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Eser Oluşturma Tarihi</label>
                            <select class="mapping-select" data-db-field="creationDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Yayın Tarihi</label>
                            <select class="mapping-select" data-db-field="publicationDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Yayınevi/Yapımcı</label>
                            <select class="mapping-select" data-db-field="publisher"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Tasarım Türü</label>
                            <select class="mapping-select" data-db-field="designType"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Locarno Sınıfı</label>
                            <select class="mapping-select" data-db-field="locarnoClass"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Tasarım Tarihi</label>
                            <select class="mapping-select" data-db-field="designDate"></select>
                        </div>
                        <div class="mapping-item">
                            <label class="mapping-label">Tasarım Özellikleri</label>
                            <select class="mapping-select" data-db-field="designFeatures"></select>
                        </div>

                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelUploadBtn">
                        İptal
                    </button>
                    <button type="submit" class="btn btn-primary" id="uploadBtn" disabled>
                        <span id="uploadText">Verileri Yükle</span>
                        <span class="loading-spinner" id="uploadLoading" style="display: none;"></span>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script type="module">
        import { authService, ipRecordsService, personsService, auth } from './firebase-config.js';

        class ExcelUploadModule {
            constructor() {
                this.selectedFile = null;
                this.workbook = null;
                this.dataRows = []; // Excel'den okunan ham veri
                this.columnHeaders = []; // Excel'den okunan sütun başlıkları
                this.currentUser = null;
                this.allPersons = []; // Hak sahiplerini eşleştirmek için tüm kişiler
                this.init();
            }

            init() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        this.currentUser = authService.getCurrentUser();
                        console.log('✅ User authenticated for Excel Upload:', this.currentUser.email, 'Role:', this.currentUser.role);
                        await this.loadAllPersons(); // Kişileri yükle
                        this.initializeEventListeners();
                    } else {
                        const localUser = authService.getCurrentUser();
                        if (localUser && localUser.uid) {
                            this.currentUser = localUser;
                            console.log('⚠️ LocalStorage user detected for Excel Upload, running in local mode:', this.currentUser.email, 'Role:', this.currentUser.role);
                            await this.loadAllPersons(); // Kişileri yükle
                            this.initializeEventListeners();
                        } else {
                            console.log('❌ User not authenticated, redirecting to login page.');
                            window.location.href = 'index.html';
                        }
                    }
                });
                console.log('📤 Excel Yükleme Modülü başlatılıyor...');
            }

            async loadAllPersons() {
                try {
                    const result = await personsService.getPersons();
                    if (result.success) {
                        this.allPersons = result.data;
                        console.log('👥 All persons loaded for mapping:', this.allPersons.length);
                    } else {
                        console.error('Failed to load all persons for Excel upload:', result.error);
                        this.showNotification('Kişiler yüklenirken bir hata oluştu: ' + (result.error || 'Bilinmeyen Hata'), 'error');
                    }
                } catch (error) {
                    console.error('Error in loadAllPersons:', error);
                    this.showNotification('Kişiler yüklenirken ağ hatası oluştu.', 'error');
                }
            }

            initializeEventListeners() {
                document.getElementById('backBtn').addEventListener('click', () => {
                    if (confirm('Değişiklikler kaybolacak. Devam etmek istiyor musunuz?')) {
                        window.location.href = 'portfolio.html';
                    }
                });

                const fileUploadArea = document.getElementById('fileUploadArea');
                const excelFileInput = document.getElementById('excelFile');

                fileUploadArea.addEventListener('click', () => excelFileInput.click());
                excelFileInput.addEventListener('change', (e) => this.handleFile(e.target.files[0]));

                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.style.borderColor = '#1e3c72';
                    fileUploadArea.style.background = '#f0f4f8';
                });
                fileUploadArea.addEventListener('dragleave', () => {
                    fileUploadArea.style.borderColor = '#e1e8ed';
                    fileUploadArea.style.background = 'transparent';
                });
                fileUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUploadArea.style.borderColor = '#e1e8ed';
                    fileUploadArea.style.background = 'transparent';
                    this.handleFile(e.dataTransfer.files[0]);
                });

                document.getElementById('sheetName').addEventListener('change', () => this.readSelectedSheet());
                document.getElementById('hasHeader').addEventListener('change', () => this.readSelectedSheet());

                document.getElementById('uploadBtn').addEventListener('click', () => this.uploadDataToDatabase());
                document.getElementById('cancelUploadBtn').addEventListener('click', () => this.resetForm());
            }

            showNotification(message, type = 'info') {
                const successDiv = document.getElementById('successMessage');
                const errorDiv = document.getElementById('errorMessage');
                const infoDiv = document.getElementById('infoMessage');

                successDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                infoDiv.style.display = 'none';

                let targetDiv;
                if (type === 'success') {
                    targetDiv = successDiv;
                    document.getElementById('successText').textContent = message;
                } else if (type === 'error') {
                    targetDiv = errorDiv;
                    document.getElementById('errorText').textContent = message;
                } else {
                    targetDiv = infoDiv;
                    document.getElementById('infoText').textContent = message;
                }

                targetDiv.style.display = 'flex';
                
                // Belirli bir süre sonra mesajı otomatik gizle (isteğe bağlı)
                if (type !== 'error') { // Hata mesajları kalıcı olabilir
                    setTimeout(() => {
                        targetDiv.style.display = 'none';
                    }, 5000);
                }
            }

            setLoading(isLoading) {
                const uploadBtn = document.getElementById('uploadBtn');
                const uploadText = document.getElementById('uploadText');
                const uploadLoading = document.getElementById('uploadLoading');

                uploadBtn.disabled = isLoading;
                uploadText.style.display = isLoading ? 'none' : 'inline';
                uploadLoading.style.display = isLoading ? 'inline-block' : 'none';
            }

            async handleFile(file) {
                if (!file) {
                    this.resetForm(); // Dosya seçilmezse formu sıfırla
                    return;
                }

                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (!['xlsx', 'xls'].includes(fileExtension)) {
                    this.showNotification('Lütfen geçerli bir Excel dosyası (.xlsx veya .xls) seçin.', 'error');
                    this.resetForm();
                    return;
                }

                this.selectedFile = file;
                this.showNotification(`Dosya seçildi: ${file.name}. Okunuyor...`, 'info');
                this.setLoading(true);
                document.getElementById('uploadBtn').disabled = true; // Yükleme butonunu başlangıçta devre dışı bırak

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        this.workbook = XLSX.read(data, { type: 'array' });
                        this.populateSheetDropdown();
                        document.getElementById('sheetSelectionGroup').style.display = 'block';
                        document.getElementById('headerRowGroup').style.display = 'block'; // Doğru ID kullanıldı

                        this.readSelectedSheet(); // İlk sayfayı otomatik oku
                        this.setLoading(false);
                    } catch (error) {
                        console.error('Excel dosyası işlenirken hata:', error);
                        this.showNotification('Excel dosyası işlenirken bir hata oluştu. Dosya bozuk veya format hatası olabilir.', 'error');
                        this.resetForm();
                        this.setLoading(false);
                    }
                };
                reader.onerror = (error) => {
                    console.error('Dosya okuma hatası:', error);
                    this.showNotification('Dosya okunamadı. Lütfen tekrar deneyin.', 'error');
                    this.resetForm();
                    this.setLoading(false);
                };
                reader.readAsArrayBuffer(file);
            }

            populateSheetDropdown() {
                const sheetSelect = document.getElementById('sheetName');
                sheetSelect.innerHTML = '';
                this.workbook.SheetNames.forEach(sheetName => {
                    const option = document.createElement('option');
                    option.value = sheetName;
                    option.textContent = sheetName;
                    sheetSelect.appendChild(option);
                });
            }

            readSelectedSheet() {
                if (!this.workbook) return;

                const sheetName = document.getElementById('sheetName').value;
                const hasHeader = document.getElementById('hasHeader').checked;

                const worksheet = this.workbook.Sheets[sheetName];
                // veriyi JSON formatına dönüştür
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (jsonData.length === 0) {
                    this.showNotification('Seçilen sayfada veri bulunamadı.', 'info');
                    document.getElementById('previewTableContainer').style.display = 'none';
                    document.getElementById('columnMappingSection').style.display = 'none';
                    document.getElementById('uploadBtn').disabled = true;
                    this.dataRows = [];
                    this.columnHeaders = [];
                    return;
                }

                this.dataRows = jsonData;
                if (hasHeader) {
                    this.columnHeaders = this.dataRows.shift(); // İlk satırı başlık olarak al
                } else {
                    this.columnHeaders = Array.from({ length: this.dataRows[0].length }, (_, i) => `Sütun ${i + 1}`);
                }

                this.renderPreviewTable();
                this.populateColumnMapping();
                document.getElementById('columnMappingSection').style.display = 'block';
                document.getElementById('uploadBtn').disabled = false; // Yükleme butonunu etkinleştir
            }

            renderPreviewTable() {
                const previewTableContainer = document.getElementById('previewTableContainer');
                const previewTable = previewTableContainer.querySelector('.preview-table');
                const thead = previewTable.querySelector('thead');
                const tbody = previewTable.querySelector('tbody');

                thead.innerHTML = '';
                tbody.innerHTML = '';

                // Başlık satırını oluştur
                const headerRow = document.createElement('tr');
                this.columnHeaders.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    thead.appendChild(th);
                });
                thead.appendChild(headerRow);

                // Veri satırlarını oluştur (ilk 10 satır önizleme için)
                this.dataRows.slice(0, 10).forEach(row => {
                    const tr = document.createElement('tr');
                    row.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                previewTableContainer.style.display = 'block';
            }

            populateColumnMapping() {
                const mappingSelects = document.querySelectorAll('.column-mapping-section .mapping-select');
                
                mappingSelects.forEach(selectElement => {
                    selectElement.innerHTML = '<option value="">Seçiniz</option>'; // Varsayılan boş seçenek
                    this.columnHeaders.forEach(header => {
                        const option = document.createElement('option');
                        option.value = header;
                        option.textContent = header;
                        selectElement.appendChild(option);
                    });
                });
            }

            async uploadDataToDatabase() {
                this.setLoading(true);
                this.showNotification('Veriler veritabanına aktarılıyor...', 'info');

                const mappedColumns = {};
                let isValidMapping = true;

                // Zorunlu alanların eşleştirilmesini kontrol et
                document.querySelectorAll('.required-mapping').forEach(selectElement => {
                    const dbField = selectElement.dataset.dbField;
                    const selectedExcelColumn = selectElement.value;
                    if (!selectedExcelColumn) {
                        isValidMapping = false;
                        this.showNotification(`Zorunlu alan '${dbField}' için bir sütun eşleştirmesi seçmelisiniz.`, 'error');
                    }
                    mappedColumns[dbField] = selectedExcelColumn;
                });

                if (!isValidMapping) {
                    this.setLoading(false);
                    return;
                }

                const recordsToUpload = [];
                const headerRowIndex = this.columnHeaders.reduce((acc, header, index) => {
                    acc[header] = index;
                    return acc;
                }, {});

                for (const row of this.dataRows) {
                    const record = {};
                    for (const dbField in mappedColumns) {
                        const excelColumnName = mappedColumns[dbField];
                        const columnIndex = headerRowIndex[excelColumnName];
                        if (columnIndex !== undefined && row[columnIndex] !== undefined) {
                            record[dbField] = row[columnIndex];
                        } else {
                            record[dbField] = null; // Eşleşmeyen veya boş hücreler için null
                        }
                    }
                    
                    // Veri dönüşümleri ve doğrulama
                    try {
                        const processedRecord = await this.processRecordForUpload(record);
                        if (processedRecord) {
                            recordsToUpload.push(processedRecord);
                        } else {
                            // Hatalı satırı atla veya kaydet
                            console.warn('Hatalı satır atlandı:', row);
                            // Sadece bilgi mesajı göster, hata değil, tüm satırları engellemesin
                            this.showNotification(`Bazı satırlar işlenirken hata oluştu ve atlandı. Detaylar konsolda.`, 'info');
                        }
                    } catch (error) {
                        console.error('Kayıt işlenirken kritik hata:', row, error);
                        this.showNotification(`Bazı satırlar işlenirken kritik hata oluştu ve atlandı. Detaylar konsolda.`, 'error');
                    }
                }

                if (recordsToUpload.length === 0) {
                    this.showNotification('Hiç geçerli kayıt bulunamadı. Lütfen Excel dosyanızı kontrol edin.', 'error');
                    this.setLoading(false);
                    return;
                }

                let successCount = 0;
                let failCount = 0;

                for (const record of recordsToUpload) {
                    try {
                        const result = await ipRecordsService.addRecord(record);
                        if (result.success) {
                            successCount++;
                        } else {
                            failCount++;
                            console.error('Tekil kayıt eklenirken hata:', record, result.error);
                        }
                    } catch (error) {
                        failCount++;
                        console.error('Tekil kayıt eklenirken beklenmeyen hata:', record, error);
                    }
                }

                if (successCount > 0) {
                    this.showNotification(`${successCount} kayıt başarıyla eklendi!`, 'success');
                }
                if (failCount > 0) {
                    this.showNotification(`${failCount} kayıt eklenirken hata oluştu.`, 'error');
                }
                if (successCount === 0 && failCount === 0) {
                    this.showNotification('Hiçbir kayıt aktarılamadı.', 'error');
                }

                this.setLoading(false);
                this.resetForm(); // İşlem bittikten sonra formu sıfırla
            }

            async processRecordForUpload(rawRecord) {
                const processedRecord = {};

                // IP Türü kontrolü
                const ipTypeMap = {
                    "patent": "patent", "marka": "trademark", "telif hakkı": "copyright", "tasarım": "design",
                    "patent ": "patent", "marka ": "trademark", "telif hakkı ": "copyright", "tasarım ": "design",
                    // İngilizce karşılıkları da eklenebilir
                    "patent": "patent", "trademark": "trademark", "copyright": "copyright", "design": "design"
                };
                const rawType = String(rawRecord.type || '').toLowerCase().trim();
                processedRecord.type = ipTypeMap[rawType] || null;
                if (!processedRecord.type) {
                    this.showNotification(`Geçersiz IP Türü: '${rawRecord.type}'. Satır atlandı.`, 'info');
                    return null;
                }

                // Başlık
                processedRecord.title = String(rawRecord.title || '').trim();
                if (!processedRecord.title) {
                    this.showNotification(`Başlık boş. Satır atlandı.`, 'info');
                    return null;
                }

                // Durum kontrolü
                const statusMap = {
                    "başvuru": "application", "beklemede": "pending", "onaylandı": "approved", "reddedildi": "rejected", "süresi doldu": "expired",
                    "yayınlandı": "published", "kısmi ret": "partial_refusal", "ret": "refused", "itiraz geldi": "opposition_received",
                    "itiraz edildi": "opposition_filed", "tescilli": "registered", "yenilenmedi": "not_renewed",
                    "başvuru geçersiz/hükümsüz": "invalid_void",
                    // İngilizce karşılıkları
                    "application": "application", "pending": "pending", "approved": "approved", "rejected": "rejected", "expired": "expired",
                    "published": "published", "partial refusal": "partial_refusal", "refused": "refused", "opposition received": "opposition_received",
                    "opposition filed": "opposition_filed", "registered": "registered", "not renewed": "not_renewed",
                    "invalid/void": "invalid_void"
                };
                const rawStatus = String(rawRecord.status || '').toLowerCase().trim();
                processedRecord.status = statusMap[rawStatus] || 'pending'; // Varsayılan olarak 'beklemede'

                // Tarih dönüşümleri (Önemli: Excel tarihleri sayı olarak gelebilir)
                processedRecord.applicationDate = this.excelDateToISO(rawRecord.applicationDate);
                if (!processedRecord.applicationDate) {
                    this.showNotification(`Başvuru Tarihi geçersiz veya boş. Satır atlandı.`, 'info');
                    return null;
                }

                // Açıklama
                processedRecord.description = String(rawRecord.description || '').trim();
                if (!processedRecord.description) {
                    this.showNotification(`Açıklama boş. Satır atlandı.`, 'info');
                    return null;
                }

                // Hak Sahipleri - Excel'den gelen isimleri kullanarak var olan kişileri bul
                processedRecord.owners = [];
                const rawOwners = String(rawRecord.owners || '').split(',').map(name => name.trim()).filter(name => name);
                for (const ownerName of rawOwners) {
                    const foundPerson = this.allPersons.find(p => p.name.toLowerCase() === ownerName.toLowerCase());
                    if (foundPerson) {
                        processedRecord.owners.push(foundPerson);
                    } else {
                        // Yeni kişi oluşturma veya uyarı verme
                        console.warn(`Hak sahibi bulunamadı: '${ownerName}'. Yeni kişi olarak eklenecek.`);
                        const newPerson = {
                            name: ownerName,
                            email: '', // Excel'de email/telefon yoksa boş bırak
                            phone: '',
                            type: 'individual', // Varsayılan olarak Bireysel
                            address: '',
                        };
                        try {
                            const addPersonResult = await personsService.addPerson(newPerson);
                            if (addPersonResult.success) {
                                processedRecord.owners.push({ id: addPersonResult.id, ...newPerson });
                                this.allPersons.push({ id: addPersonResult.id, ...newPerson }); // Yeni eklenen kişiyi listeye ekle
                            } else {
                                console.error(`Yeni hak sahibi '${ownerName}' eklenemedi:`, addPersonResult.error);
                            }
                        } catch (e) {
                            console.error(`Yeni hak sahibi '${ownerName}' eklenirken hata:`, e);
                        }
                    }
                }
                if (processedRecord.owners.length === 0) {
                    this.showNotification(`Hak Sahibi bulunamadı veya oluşturulamadı. Satır atlandı.`, 'info');
                    return null;
                }


                // Diğer isteğe bağlı alanları ekle
                processedRecord.applicationNumber = String(rawRecord.applicationNumber || '').trim();
                processedRecord.registrationNumber = String(rawRecord.registrationNumber || '').trim();
                processedRecord.renewalDate = this.excelDateToISO(rawRecord.renewalDate);
                processedRecord.bulletinDate = this.excelDateToISO(rawRecord.bulletinDate);
                processedRecord.bulletinNumber = String(rawRecord.bulletinNumber || '').trim();
                processedRecord.patentClass = String(rawRecord.patentClass || '').trim();
                processedRecord.expiryDate = this.excelDateToISO(rawRecord.expiryDate);
                processedRecord.priority = this.excelDateToISO(rawRecord.priority);
                processedRecord.claims = String(rawRecord.claims || '').trim();
                processedRecord.trademarkType = String(rawRecord.trademarkType || '').trim();
                processedRecord.niceClass = String(rawRecord.niceClass || '').trim();
                processedRecord.goodsServices = String(rawRecord.goodsServices || '').trim();
                processedRecord.workType = String(rawRecord.workType || '').trim();
                processedRecord.creationDate = this.excelDateToISO(rawRecord.creationDate);
                processedRecord.publicationDate = this.excelDateToISO(rawRecord.publicationDate);
                processedRecord.publisher = String(rawRecord.publisher || '').trim();
                processedRecord.designType = String(rawRecord.designType || '').trim();
                processedRecord.locarnoClass = String(rawRecord.locarnoClass || '').trim();
                processedRecord.designDate = this.excelDateToISO(rawRecord.designDate);
                processedRecord.designFeatures = String(rawRecord.designFeatures || '').trim();

                // Ortak alanlar
                processedRecord.createdAt = new Date().toISOString();
                processedRecord.updatedAt = new Date().toISOString();
                processedRecord.userId = this.currentUser.uid;
                processedRecord.userEmail = this.currentUser.email;
                processedRecord.files = []; // Excel'den dosya yükleme desteklenmiyorsa boş bırak

                return processedRecord;
            }

            excelDateToISO(excelDate) {
                if (typeof excelDate === 'number') {
                    // Excel'deki 0. gün 30 Aralık 1899'dur. JavaScript tarihi 1 Ocak 1970'ten başlar.
                    const date = new Date(Date.UTC(0, 0, excelDate - 1)); // -1 çünkü Excel 1900'ü artık yıl sanır.
                    return date.toISOString().split('T')[0];
                } else if (typeof excelDate === 'string' && excelDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    // Zaten YYYY-MM-DD formatında ise direkt kullan
                    return excelDate;
                } else if (excelDate) {
                    // Diğer string formatları için deneme
                    try {
                        const date = new Date(excelDate);
                        if (!isNaN(date.getTime())) {
                            return date.toISOString().split('T')[0];
                        }
                    } catch (e) {
                        console.warn('Tarih formatı dönüştürülemedi:', excelDate);
                    }
                }
                return null;
            }

            resetForm() {
                this.selectedFile = null;
                this.workbook = null;
                this.dataRows = [];
                this.columnHeaders = [];
                document.getElementById('excelFile').value = '';
                document.getElementById('sheetSelectionGroup').style.display = 'none';
                document.getElementById('hasHeader').checked = true;
                document.getElementById('headerRowGroup').style.display = 'none'; // Bunu da resetle
                document.getElementById('previewTableContainer').style.display = 'none';
                document.getElementById('columnMappingSection').style.display = 'none';
                document.getElementById('uploadBtn').disabled = true;
                document.getElementById('previewTableContainer').querySelector('thead').innerHTML = '';
                document.getElementById('previewTableContainer').querySelector('tbody').innerHTML = '';
                this.showNotification('Form sıfırlandı. Yeni bir dosya yükleyebilirsiniz.', 'info');
                this.setLoading(false);
            }
        }

        let excelUploadModule;
        auth.onAuthStateChanged((user) => {
            if (!excelUploadModule) {
                excelUploadModule = new ExcelUploadModule();
            }
        });
    </script>
</body>
</html>