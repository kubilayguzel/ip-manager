<script type="module">
        import { authService, taskService, ipRecordsService, personsService, auth, generateUUID } from './firebase-config.js';

        class MyTasksModule {
            constructor() {
                this.currentUser = null;
                this.tasks = [];
                this.allIpRecords = [];
                this.allPersons = [];
                this.allUsers = [];
                this.uploadedCompletionFiles = [];
                this.uploadedEditFiles = [];
                this.currentEditTask = null;
                this.init();
            }

            init() {
                authService.auth.onAuthStateChanged(async user => {
                    if (user) {
                        this.currentUser = authService.getCurrentUser();
                        this.updateUserInfo();
                        await this.loadInitialData();
                        this.setupEventListeners();
                    } else {
                        window.location.href = 'index.html';
                    }
                });
            }

            updateUserInfo() {
                if (this.currentUser) {
                    const userName = this.currentUser.displayName || this.currentUser.email.split('@')[0] || 'KullanÄ±cÄ±';
                    const userRole = this.currentUser.role === 'admin' ? 'YÃ¶netici' : this.currentUser.role === 'superadmin' ? 'SÃ¼per YÃ¶netici' : 'KullanÄ±cÄ±';
                    document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
                    document.getElementById('userName').textContent = userName;
                    document.getElementById('userRole').textContent = userRole;
                }
            }
            
            async loadInitialData() {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('noTasksMessage').style.display = 'none';
                document.getElementById('tasksTableBody').innerHTML = '';
                try {
                    const [tasksResult, ipRecordsResult, personsResult, usersResult] = await Promise.all([
                        taskService.getTasksForUser(this.currentUser.uid),
                        ipRecordsService.getRecords(),
                        personsService.getPersons(),
                        taskService.getAllUsers()
                    ]);

                    if (tasksResult.success) this.tasks = tasksResult.data; else throw new Error(tasksResult.error || 'GÃ¶revler yÃ¼klenemedi');
                    if (ipRecordsResult.success) this.allIpRecords = ipRecordsResult.data; else throw new Error(ipRecordsResult.error || 'IP KayÄ±tlarÄ± yÃ¼klenemedi');
                    if (personsResult.success) this.allPersons = personsResult.data; else throw new Error(personsResult.error || 'KiÅŸiler yÃ¼klenemedi');
                    if (usersResult.success) this.allUsers = usersResult.data; else throw new Error(usersResult.error || 'KullanÄ±cÄ±lar yÃ¼klenemedi');
                    
                    this.renderTasks();

                } catch (error) {
                    console.error('BaÅŸlangÄ±Ã§ verileri yÃ¼klenirken hata:', error);
                    alert('Veriler yÃ¼klenirken bir hata oluÅŸtu: ' + error.message);
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            setupEventListeners() {
                document.getElementById('logoutBtn').addEventListener('click', () => authService.signOut().then(() => window.location.href = 'index.html'));
                document.getElementById('statusFilter').addEventListener('change', (e) => this.renderTasks(e.target.value));

                // Modals
                document.getElementById('closeViewTaskDetailModal').addEventListener('click', () => this.closeModal('viewTaskDetailModal'));
                document.getElementById('closeEditTaskModal').addEventListener('click', () => this.closeModal('editTaskModal'));
                document.getElementById('cancelEditTaskBtn').addEventListener('click', () => this.closeModal('editTaskModal'));
                document.getElementById('saveTaskChangesBtn').addEventListener('click', () => this.saveTaskChanges());
                document.getElementById('modalTaskDetailFileUploadArea').addEventListener('click', () => document.getElementById('modalTaskDetailFileInput').click());
                document.getElementById('modalTaskDetailFileInput').addEventListener('change', (e) => this.handleEditDocumentUpload(e.target.files));
                document.getElementById('closeCompleteTaskModal').addEventListener('click', () => this.closeModal('completeTaskModal'));
                document.getElementById('cancelCompleteTaskBtn').addEventListener('click', () => this.closeModal('completeTaskModal'));
                document.getElementById('submitCompleteTaskBtn').addEventListener('click', () => this.completeTask('completed_with_doc'));
                document.getElementById('clientApprovalBtn').addEventListener('click', () => this.completeTask('client_approved'));
                document.getElementById('manualCloseBtn').addEventListener('click', () => this.completeTask('manually_closed'));
                document.getElementById('completeTaskDocumentInput').addEventListener('change', (e) => this.handleDocumentUploadForTaskCompletion(e.target.files));
                document.getElementById('completeTaskFileUploadArea').addEventListener('click', () => document.getElementById('completeTaskDocumentInput').click());
                document.getElementById('closeIpRecordModalBtn').addEventListener('click', () => this.closeModal('ipRecordDetailModal'));
            }

            renderTasks(filter = 'all') {
                const tableBody = document.getElementById('tasksTableBody');
                const noTasksMessage = document.getElementById('noTasksMessage');
                tableBody.innerHTML = '';

                // HATA BURADAYDI: Bu satÄ±rÄ±n var olduÄŸundan emin olun.
                // Bu deÄŸiÅŸken, gÃ¶revleri filtrelemek iÃ§in kullanÄ±lÄ±r.
                const filteredTasks = this.tasks.filter(task => filter === 'all' || task.status === filter);
                
                if (filteredTasks.length === 0) {
                    noTasksMessage.style.display = 'block';
                    return;
                }
                
                noTasksMessage.style.display = 'none'; 
                const priorityMap = { high: 'YÃ¼ksek', medium: 'Orta', low: 'DÃ¼ÅŸÃ¼k' };
                const statusMap = { open: 'AÃ§Ä±k', in_progress: 'Devam Ediyor', completed: 'TamamlandÄ±', pending_review: 'GÃ¶zden GeÃ§iriliyor' };

                // Hata alÄ±nan dÃ¶ngÃ¼: 'filteredTasks' artÄ±k tanÄ±mlÄ± olduÄŸu iÃ§in sorunsuz Ã§alÄ±ÅŸacaktÄ±r.
                filteredTasks.forEach(task => {
                    const row = document.createElement('tr');
                    const relatedIpRecordTitle = task.relatedIpRecordTitle || '-'; 
                    const relatedIpRecordId = task.relatedIpRecordId || '';

                    row.innerHTML = `
                        <td><span class="priority-${task.priority}">${priorityMap[task.priority] || 'Normal'}</span></td>
                        <td>${task.title}</td>
                        <td><a href="#" class="ip-record-link" data-ip-record-id="${relatedIpRecordId}">${relatedIpRecordTitle}</a></td> 
                        <td>${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : '-'}</td>
                        <td><span class="status-badge status-${task.status}">${statusMap[task.status] || task.status}</span></td>
                        <td>
                            <button class="action-btn view-btn" data-id="${task.id}">GÃ¶rÃ¼ntÃ¼le</button>
                            <button class="action-btn edit-btn" data-id="${task.id}">GÃ¼ncelle</button>
                            <button class="action-btn delete-btn" data-id="${task.id}">Sil</button>
                            <button class="action-btn complete-btn" data-id="${task.id}" data-ip-record-id="${task.relatedIpRecordId}" ${task.status === 'completed' ? 'disabled' : ''}>Ä°ÅŸi Bitir</button> 
                        </td>
                    `;
                    
                    row.querySelector('.view-btn').addEventListener('click', () => this.viewTaskDetailsModal(task.id));
                    row.querySelector('.edit-btn').addEventListener('click', () => this.editTask(task.id));
                    row.querySelector('.delete-btn').addEventListener('click', () => this.deleteTask(task.id));
                    row.querySelector('.complete-btn').addEventListener('click', () => this.showCompleteTaskModal(task.id, task.relatedIpRecordId));
                    
                    const ipRecordLink = row.querySelector('.ip-record-link');
                    if (ipRecordLink && relatedIpRecordId) {
                        ipRecordLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.showIpRecordDetailModal(relatedIpRecordId);
                        });
                    }
                    tableBody.appendChild(row);
                });
            }
            
            editTask(taskId) { this.showEditTaskModal(taskId); }

            async deleteTask(taskId) {
                if (confirm('Bu gÃ¶revi silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.')) {
                    try {
                        const result = await taskService.deleteTask(taskId);
                        if (result.success) { alert('GÃ¶rev baÅŸarÄ±yla silindi.'); await this.loadInitialData(); } 
                        else { throw new Error(result.error); }
                    } catch (error) { console.error('GÃ¶rev silinirken hata:', error); alert('GÃ¶rev silinirken bir hata oluÅŸtu: ' + error.message); }
                }
            }

            async viewTaskDetailsModal(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) { alert('GÃ¶rev bulunamadÄ±.'); return; }
                this.populateModalTaskDetails(task, this.allIpRecords, this.allPersons);
                document.getElementById('viewTaskDetailModal').classList.add('show');
            }

            showEditTaskModal(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) { alert('DÃ¼zenlenecek gÃ¶rev bulunamadÄ±.'); return; }
                this.currentEditTask = task;
                this.uploadedEditFiles = [];
                document.getElementById('editTaskId').value = task.id;
                document.getElementById('modalEditTaskTitle').value = task.title || '';
                document.getElementById('modalEditTaskDescription').value = task.description || '';
                document.getElementById('modalEditTaskDueDate').value = task.dueDate || '';
                const prioritySelect = document.getElementById('modalEditTaskPriority');
                prioritySelect.innerHTML = '';
                const priorities = { low: 'DÃ¼ÅŸÃ¼k', medium: 'Orta', high: 'YÃ¼ksek' };
                for (const [key, value] of Object.entries(priorities)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = value;
                    if (key === task.priority) option.selected = true;
                    prioritySelect.appendChild(option);
                }
                const assignedToSelect = document.getElementById('modalEditAssignedTo');
                assignedToSelect.innerHTML = '';
                this.allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.displayName || user.email;
                    if (user.id === task.assignedTo_uid) option.selected = true;
                    assignedToSelect.appendChild(option);
                });
                this.renderEditFileList(true);
                document.getElementById('editTaskModal').classList.add('show');
            }

            async saveTaskChanges() {
                const taskId = document.getElementById('editTaskId').value;
                const updates = {
                    title: document.getElementById('modalEditTaskTitle').value.trim(),
                    description: document.getElementById('modalEditTaskDescription').value.trim(),
                    priority: document.getElementById('modalEditTaskPriority').value,
                    assignedTo_uid: document.getElementById('modalEditAssignedTo').value,
                    dueDate: document.getElementById('modalEditTaskDueDate').value,
                    files: (this.currentEditTask.files || []).concat(this.uploadedEditFiles)
                };
                updates.assignedTo_email = this.allUsers.find(u => u.id === updates.assignedTo_uid)?.email;
                try {
                    const result = await taskService.updateTask(taskId, updates);
                    if (result.success) {
                        alert('Ä°ÅŸ baÅŸarÄ±yla gÃ¼ncellendi!');
                        this.closeModal('editTaskModal');
                        await this.loadInitialData();
                    } else { throw new Error(result.error); }
                } catch(error) { alert('Ä°ÅŸ gÃ¼ncellenirken bir hata oluÅŸtu: ' + error.message); }
            }

            handleEditDocumentUpload(files) {
                for (const file of files) {
                    const isDuplicate = (this.currentEditTask.files || []).some(f => f.name === file.name) || this.uploadedEditFiles.some(f => f.name === file.name);
                    if(isDuplicate) { alert(`"${file.name}" adlÄ± dosya zaten listede.`); continue; }
                    this.readFileAsDataURL(file).then(dataUrl => {
                        this.uploadedEditFiles.push({
                            id: generateUUID(), name: file.name, size: file.size, type: file.type,
                            content: dataUrl, uploadedAt: new Date().toISOString(),
                            documentDesignation: 'Ä°ÅŸ GÃ¼ncelleme DokÃ¼manÄ±'
                        });
                        this.renderEditFileList();
                    });
                }
            }

            renderEditFileList(isInitial = false) {
                const existingList = document.getElementById('modalEditTaskDocumentList');
                const newList = document.getElementById('modalTaskDetailUploadedFileList');
                if (isInitial) {
                    existingList.innerHTML = '';
                    const existingFiles = this.currentEditTask.files || [];
                    if (existingFiles.length === 0) { existingList.innerHTML = '<li id="modalNoTaskDocumentsMessage">HenÃ¼z dokÃ¼man yok.</li>';
                    } else {
                        existingFiles.forEach(file => {
                            const li = document.createElement('li');
                            li.innerHTML = `<a href="${file.content}" download="${file.name}">ðŸ“„ ${file.name}</a><button class="remove-doc-btn" data-id="${file.id}">Ã—</button>`;
                            li.querySelector('.remove-doc-btn').addEventListener('click', (e) => {
                                if(confirm('Bu dokÃ¼manÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?')) {
                                    this.currentEditTask.files = this.currentEditTask.files.filter(f => f.id !== e.target.dataset.id);
                                    this.renderEditFileList(true);
                                }
                            });
                            existingList.appendChild(li);
                        });
                    }
                }
                newList.innerHTML = '';
                this.uploadedEditFiles.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'file-item-task-detail';
                    item.innerHTML = `<span>${file.name}</span><button class="remove-file-task-detail" data-id="${file.id}">Ã—</button>`;
                    item.querySelector('.remove-file-task-detail').addEventListener('click', (e) => {
                        this.uploadedEditFiles = this.uploadedEditFiles.filter(f => f.id !== e.target.dataset.id);
                        this.renderEditFileList();
                    });
                    newList.appendChild(item);
                });
            }

            populateModalTaskDetails(task, ipRecords, persons) { /* Unchanged */ }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('show');
                if (modalId === 'completeTaskModal') {
                    this.uploadedCompletionFiles = [];
                    document.getElementById('completeTaskFileList').innerHTML = '';
                }
                if (modalId === 'editTaskModal') { this.uploadedEditFiles = []; this.currentEditTask = null; }
            }
            
            showCompleteTaskModal(taskId, relatedIpRecordId) {
                document.getElementById('completeTaskId').value = taskId;
                document.getElementById('completeTaskRelatedIpRecordId').value = relatedIpRecordId;
                this.uploadedCompletionFiles = [];
                document.getElementById('completeTaskFileList').innerHTML = '';
                document.getElementById('completeTaskModal').classList.add('show');
            }

            async completeTask(actionType) {
                const taskId = document.getElementById('completeTaskId').value;
                const relatedIpRecordId = document.getElementById('completeTaskRelatedIpRecordId').value;
                if (!taskId) { alert('Ä°ÅŸ ID\'si bulunamadÄ±.'); return; }
                const actionMessages = {
                    completed_with_doc: { confirm: 'Bu iÅŸi "TamamlandÄ±" olarak iÅŸaretlemek istediÄŸinizden emin misiniz?', success: 'Ä°ÅŸ baÅŸarÄ±yla tamamlandÄ±!' },
                    client_approved: { confirm: 'Bu iÅŸi "MÃ¼vekkil OnayÄ±" ile tamamlamak istediÄŸinizden emin misiniz?', success: 'Ä°ÅŸ, mÃ¼vekkil onayÄ± ile tamamlandÄ±!' },
                    manually_closed: { confirm: 'Bu iÅŸi "Manuel Kapat" olarak iÅŸaretlemek istediÄŸinizden emin misiniz?', success: 'Ä°ÅŸ, manuel olarak kapatÄ±ldÄ±!' }
                };
                const messages = actionMessages[actionType];
                if (confirm(messages.confirm)) {
                    try {
                        const result = await taskService.updateTask(taskId, { status: 'completed' });
                        if (!result.success) throw new Error(result.error || 'Ä°ÅŸ durumu gÃ¼ncellenemedi.');
                        if (this.uploadedCompletionFiles.length > 0 && relatedIpRecordId) {
                            const currentIpRecord = this.allIpRecords.find(r => r.id === relatedIpRecordId);
                            const updatedFiles = (currentIpRecord?.files || []).concat(this.uploadedCompletionFiles);
                            const ipRecordUpdateResult = await ipRecordsService.updateRecord(relatedIpRecordId, { files: updatedFiles });
                            if (!ipRecordUpdateResult.success) {
                                alert(`${messages.success} Ancak dokÃ¼manlar yÃ¼klenirken bir hata oluÅŸtu: ${ipRecordUpdateResult.error}`);
                            } else {
                                alert(`${messages.success} DokÃ¼manlar da baÅŸarÄ±yla yÃ¼klendi!`);
                            }
                        } else {
                            alert(messages.success);
                        }
                        this.closeModal('completeTaskModal');
                        await this.loadInitialData();
                    } catch (error) {
                        alert('Ä°ÅŸ tamamlanÄ±rken bir hata oluÅŸtu: ' + error.message);
                    }
                }
            }

            handleDocumentUploadForTaskCompletion(files) { /* Unchanged */ }
            renderDocumentListForTaskCompletion() { /* Unchanged */ }
            readFileAsDataURL(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(file); }); }
            formatFileSize(bytes) { if (bytes === 0) return '0 Bytes'; const k = 1024; const i = Math.floor(Math.log(bytes) / Math.log(k)); return `${parseFloat((bytes / Math.pow(k, i)).toFixed(2))} ${['Bytes', 'KB', 'MB', 'GB'][i]}`; }
            async showIpRecordDetailModal(recordId) { /* Unchanged */ }
            renderIpRecordTransactionHistory(recordId, transactions, recordFiles) { /* Unchanged */ }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const accordions = document.querySelectorAll('.accordion-header');
            accordions.forEach(accordion => { accordion.addEventListener('click', function(event) { this.classList.toggle('active'); const content = this.nextElementSibling; if (content.style.maxHeight) { content.style.maxHeight = null; } else { content.style.maxHeight = content.scrollHeight + "px"; } }); });
            function setActiveMenu() { const currentPage = window.location.pathname.split("/").pop() || 'dashboard.html'; document.querySelectorAll('.sidebar-nav-item.active, .accordion-content a.active').forEach(el => el.classList.remove('active')); const activeLink = document.querySelector(`.sidebar-nav a[href="${currentPage}"]`); if (!activeLink) return; activeLink.classList.add('active'); const parentAccordionContent = activeLink.closest('.accordion-content'); if (parentAccordionContent) { const parentAccordionHeader = parentAccordionContent.previousElementSibling; if (parentAccordionHeader && parentAccordionHeader.classList.contains('accordion-header')) { parentAccordionHeader.classList.add('active'); parentAccordionContent.style.maxHeight = parentAccordionContent.scrollHeight + "px"; } } }
            setActiveMenu();
        });

        let myTasksModuleInstance;
        auth.onAuthStateChanged((user) => {
            if (user || authService.getCurrentUser()) {
                if (!myTasksModuleInstance) {
                    myTasksModuleInstance = new MyTasksModule();
                }
            } else {
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>