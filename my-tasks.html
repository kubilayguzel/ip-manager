<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - İşlerim</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* BODY VE YENİ LAYOUT */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            display: flex;
        }
        
        .page-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
.main-container {
    width: 100%; /* Genişliği tamamen doldurmasını sağlar */
    padding: 30px; /* İçeriğin kenarlara yapışmaması için boşluk bırakır */
    margin: 0; /* Otomatik ortalamayı kaldırır */
}

        /* ESKİ HEADER'I GİZLE */
        body > .header { display: none; }

        /* === YENİ SOL MENÜ VE ÜST BAR STİLLERİ === */
        .sidebar { width: 260px; background: #1e3c72; color: white; display: flex; flex-direction: column; transition: width 0.3s ease; height: 100vh; position: sticky; top: 0; z-index: 1001; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar-logo { font-size: 1.8em; font-weight: bold; color: white; text-decoration: none; }
        .sidebar-nav { flex-grow: 1; overflow-y: auto; padding: 20px 0; }
        .nav-category-title { padding: 10px 20px; font-size: 0.8em; font-weight: bold; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; }
        .sidebar-nav-item, .accordion-header { display: flex; align-items: center; gap: 15px; padding: 15px 20px; color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: background 0.3s ease; cursor: pointer; }
        .sidebar-nav-item:hover, .accordion-header:hover { background: rgba(255, 255, 255, 0.1); }
        .sidebar-nav-item.active { background: #2a5298; color: white; font-weight: bold; border-left: 4px solid #4ecdc4; padding-left: 16px; }
        .nav-icon { font-size: 1.2em; width: 20px; text-align: center; }
        .accordion-header::after { content: '▶'; margin-left: auto; font-size: 0.8em; transition: transform 0.3s ease; }
        .accordion-header.active::after { transform: rotate(90deg); }
        .accordion-content { background: rgba(0, 0, 0, 0.2); max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-content a { display: block; padding: 12px 20px 12px 55px; color: rgba(255, 255, 255, 0.7); text-decoration: none; transition: background 0.2s ease; }
        .accordion-content a:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .accordion-content a.active { color: white; font-weight: 500; }
        .top-header { background: rgba(255, 255, 255, 0.95); padding: 15px 30px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); display: flex; justify-content: flex-end; align-items: center; position: sticky; top: 0; z-index: 99; backdrop-filter: blur(10px); }
        .user-section { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; background: linear-gradient(45deg, #1e3c72, #2a5298); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; color: #333; }
        .user-role { font-size: 0.8em; color: #666; }
        .logout-btn { background: #ff6b6b; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; }
        .logout-btn:hover { background: #ff5252; }
        
        /* === MY-TASKS SAYFASINA AİT ORİJİNAL STİLLER === */
        .page-header { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .page-title { font-size: 2em; color: #1e3c72; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1em; }
        .tasks-container { background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .tasks-header { padding: 20px 30px; border-bottom: 1px solid #e1e8ed; display: flex; justify-content: space-between; align-items: center; }
        .filter-group { display: flex; gap: 10px; align-items: center; }
        .filter-label { font-weight: 500; }
        .filter-select { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; }
        .task-table { width: 100%; border-collapse: collapse; }
        .task-table th, .task-table td { padding: 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .task-table th { background: #f8f9fa; font-weight: 600; }
        .task-table tr:hover { background: #f8f9fa; }
        .priority-high { color: #dc3545; font-weight: bold; }
        .priority-medium { color: #ffc107; font-weight: bold; }
        .priority-low { color: #28a745; font-weight: bold; }
        .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 500; color: white; }
        .status-open { background-color: #007bff; }
        .status-in_progress { background-color: #ffc107; color: #333; }
        .status-completed { background-color: #28a745; }
        .status-pending_review { background-color: #17a2b8; }
        .action-btn { background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; }
        .action-btn.view-btn { background-color: #17a2b8; }
        .action-btn.view-btn:hover { background-color: #138496; }
        .action-btn.edit-btn { background-color: #ffc107; color: #212529; }
        .action-btn.edit-btn:hover { background-color: #e0a800; }
        .action-btn.delete-btn { background-color: #dc3545; }
        .action-btn.delete-btn:hover { background-color: #c82333; }
        .action-btn.complete-btn { background-color: #28a745; } /* Yeni buton rengi */
        .action-btn.complete-btn:hover { background-color: #218838; }
        .no-tasks { text-align: center; padding: 50px; color: #666; }
        .loading { text-align: center; padding: 50px; }

        /* Modal Stilleri (task-detail.html'den ve portfolio.html'den kopyalandı) */
        .modal {
            display: none; /* Varsayılan olarak gizli */
            position: fixed; /* Sabit konumda */
            z-index: 1000; /* Diğer her şeyin üstünde */
            left: 0;
            top: 0;
            width: 100%; /* Tam genişlik */
            height: 100%; /* Tam yükseklik */
            overflow: auto; /* İçerik taşarsa kaydırma çubuğu */
            background-color: rgba(0,0,0,0.4); /* Yarı şeffaf arka plan */
            align-items: center; /* Dikeyde ortala */
            justify-content: center; /* Yatayda ortala */
        }
        .modal.show {
            display: flex;
        }
        .modal-content-lg { /* task-detail.html için */
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 900px;
            border-radius: 20px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
            animation-name: animatetop;
            animation-duration: 0.4s;
        }
        .modal-content { /* portfolio.html ve completeTaskModal için */
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            width: 95%; 
            max-width: 1200px; /* portfolio detay modalı daha geniş olabilir */
            max-height: 90vh; /* scrollable olması için */
            overflow-y: auto;
            border-radius: 20px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
            animation-name: animatetop;
            animation-duration: 0.4s;
        }


        /* Modal Açılış Animasyonu */
        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 0; opacity: 1}
        }

        .close-modal-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-modal-btn:hover,
        .close-modal-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-body-content {
            padding: 10px 0;
        }

        /* Ortak detay gridi stilini modal için de kullan */
        .modal-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px 25px;
        }
        .modal-detail-item {
            margin-bottom: 10px;
        }
        .modal-detail-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .modal-detail-value {
            color: #555;
            word-break: break-word;
            font-size: 0.95em;
        }
        .modal-detail-value.long-text {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
        }
        .modal-detail-section-title {
            grid-column: 1 / -1;
            font-size: 1.1em;
            color: #1e3c72;
            margin-top: 20px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #e1e8ed;
        }
        /* İşlem Geçmişi için özel stil */
        .task-history { /* task-detail.html'deki ile aynı */
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e1e8ed;
            max-height: 400px;
            overflow-y: auto;
        }
        .task-history-item { /* task-detail.html'deki ile aynı */
            position: relative;
            padding: 8px 0 8px 25px;
            border-bottom: 1px dashed #eee;
        }
        .task-history-item:last-child { /* task-detail.html'deki ile aynı */
            border-bottom: none;
        }
        .task-history-item-content { /* task-detail.html'deki ile aynı */
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .task-history-info { /* task-detail.html'deki ile aynı */
            flex-grow: 1;
        }
        .task-history-description { /* task-detail.html'deki ile aynı */
            font-size: 0.9em;
            color: #333;
            font-weight: 600;
        }
        .task-history-meta { /* task-detail.html'deki ile aynı */
            font-size: 0.8em;
            color: #666;
            white-space: nowrap;
            margin-top: 4px;
        }

        /* Doküman Yükleme Alanı Stili (my-tasks'e özgü) */
        .file-upload-area-modal {
            border: 2px dashed #e1e8ed;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }
        .file-upload-area-modal:hover {
            border-color: #1e3c72;
            background: #f0f4f8;
        }
        .file-list-modal {
            margin-top: 10px;
        }
        .file-item-modal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        .remove-file-modal {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.8em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e1e8ed;
        }
        .modal-footer .btn {
            padding: 10px 20px;
            font-size: 1em;
        }
        /* Portföy Modal Stilleri */
        .modal-content.portfolio-detail { /* Yeni sınıf */
            max-width: 1000px; /* Daha geniş */
            width: 95%;
            padding: 30px;
            border-radius: 20px;
        }
        .ip-type { /* portfolio.html'den kopyala */
            display: inline-flex; align-items: center; gap: 5px; padding: 4px 8px; border-radius: 6px; font-size: 0.8em; font-weight: 500; }
        .ip-type.patent { background: #ffebee; color: #c62828; }
        .ip-type.trademark { background: #e0f2f1; color: #00695c; }
        .ip-type.copyright { background: #e3f2fd; color: #1565c0; }
        .ip-type.design { background: #f3e5f5; color: #7b1fa2; }
        .status-badge { /* portfolio.html'den kopyala */
            display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 0.8em; font-weight: 500; }
        .status-badge.application, .status-badge.pending, .status-badge.published, .status-badge.opposition_received, .status-badge.opposition_filed  { background: #fff3cd; color: #856404; }
        .status-badge.approved, .status-badge.registered { background: #d4edda; color: #155724; }
        .status-badge.rejected, .status-badge.refused, .status-badge.partial_refusal { background: #f8d7da; color: #721c24; }
        .status-badge.expired, .status-badge.not_renewed, .status-badge.invalid_void { background: #e2e3e5; color: #383d41; }
        .modal-detail-grid.portfolio-detail {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.html" class="sidebar-logo">🔥 IP Manager</a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-category-title">Ana Menü</div>
            <a href="dashboard.html" class="sidebar-nav-item"><span class="nav-icon">📊</span><span>Dashboard</span></a>
            <a href="portfolio.html" class="sidebar-nav-item"><span class="nav-icon">📋</span><span>Portföy</span></a>
            <div class="nav-category-title">Veri Girişi</div>
            <a href="data-entry.html" class="sidebar-nav-item"><span class="nav-icon">➕</span><span>Yeni Kayıt</span></a>
            <a href="excel-upload.html" class="sidebar-nav-item"><span class="nav-icon">📄</span><span>Excel ile Yükle</span></a>
            <div class="nav-category-title">Yönetim</div>
         <div class="accordion">
    <div class="accordion-header"><span class="nav-icon">⚙️</span><span>Yönetim</span></div>
    <div class="accordion-content">
        <a href="create-task.html" class="new-task-link">Yeni İş Oluştur</a>
        
        <a href="task-management.html">İş Yönetimi</a>
        <a href="my-tasks.html">İşlerim</a>
        <a href="persons.html">Kişiler Yönetimi</a>
        <a href="user-management.html">Kullanıcı Yönetimi</a>
    </div>
</div>
            <div class="nav-category-title">Araçlar</div>
            <a href="indexing.html" class="sidebar-nav-item"><span class="nav-icon">📁</span><span>Belge İndeksleme</span></a>
            <a href="#" class="sidebar-nav-item" style="opacity: 0.5; cursor: not-allowed;"><span class="nav-icon">📈</span><span>Raporlar</span></a>
            <a href="#" class="sidebar-nav-item" style="opacity: 0.5; cursor: not-allowed;"><span class="nav-icon">🔧</span><span>Ayarlar</span></a>
        </nav>
    </aside>

    <div class="page-wrapper">
        <header class="top-header">
            <div class="user-section">
                <div class="user-avatar" id="userAvatar">?</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Yükleniyor...</div>
                    <div class="user-role" id="userRole">Kullanıcı</div>
                </div>
                <button class="logout-btn" id="logoutBtn">Çıkış</button>
            </div>
        </header>

        <main class="main-container">
            <section class="page-header">
                <h1 class="page-title">Bana Atanan İşler</h1>
                <p class="page-subtitle">Size atanmış olan tüm görevleri buradan takip edebilirsiniz.</p>
            </section>
    
            <div class="tasks-container">
                <div class="tasks-header">
                    <div class="filter-group">
                        <label class="filter-label" for="statusFilter">Duruma Göre Filtrele:</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="all">Tümü</option>
                            <option value="open">Açık</option>
                            <option value="in_progress">Devam Ediyor</option>
                            <option value="pending_review">Gözden Geçiriliyor</option>
                            <option value="completed">Tamamlandı</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <table class="task-table">
                        <thead>
                            <tr>
                                <th>Öncelik</th>
                                <th>İş Başlığı</th>
                                <th>İlgili Kayıt</th>
                                <th>Bitiş Tarihi</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                        </tbody>
                    </table>
                     <div id="loadingIndicator" class="loading">Yükleniyor...</div>
                     <div id="noTasksMessage" class="no-tasks" style="display: none;">Size atanmış aktif bir iş bulunmamaktadır.</div>
                </div>
            </div>
        </main>
    </div>

    <div id="viewTaskDetailModal" class="modal">
        <div class="modal-content-lg">
            <span class="close-modal-btn" id="closeViewTaskDetailModal">&times;</span>
            <h3 class="modal-title" id="modalViewTaskTitle">İş Detayı</h3>
            <div class="modal-body-content">
                <div class="modal-detail-grid">
                    <div class="modal-detail-item full-width">
                        <div class="modal-detail-label">İş Başlığı</div>
                        <div class="modal-detail-value" id="modalViewTaskTitleValue"></div>
                    </div>
                    <div class="modal-detail-item full-width">
                        <div class="modal-detail-label">Açıklama</div>
                        <div class="modal-detail-value long-text" id="modalViewTaskDescriptionValue"></div>
                    </div>
                    <div class="modal-detail-item">
                        <div class="modal-detail-label">İş Türü</div>
                        <div class="modal-detail-value" id="modalViewTaskTypeValue"></div>
                    </div>
                    <div class="modal-detail-item">
                        <div class="modal-detail-label">Öncelik</div>
                        <div class="modal-detail-value" id="modalViewTaskPriorityValue"></div>
                    </div>
                    <div class="modal-detail-item">
                        <div class="modal-detail-label">Atanan Kişi</div>
                        <div class="modal-detail-value" id="modalViewAssignedToValue"></div>
                    </div>
                    <div class="modal-detail-item">
                        <div class="modal-detail-label">Bitiş Tarihi</div>
                        <div class="modal-detail-value" id="modalViewTaskDueDateValue"></div>
                    </div>
                    <div class="modal-detail-item full-width">
                        <div class="modal-detail-label">İlgili Fikri Mülkiyet Kaydı</div>
                        <div class="modal-detail-value" id="modalViewRelatedIpRecordValue"></div>
                    </div>
                    <div class="modal-detail-item full-width" id="modalViewRelatedPartyGroup" style="display:none;">
                        <div class="modal-detail-label" id="modalViewRelatedPartyLabel"></div>
                        <div class="modal-detail-value" id="modalViewRelatedPartyValue"></div>
                    </div>
                    <div class="modal-detail-item full-width" id="modalViewRelatedTransactionGroup" style="display:none;">
                        <div class="modal-detail-label" id="modalViewRelatedTransactionLabel"></div>
                        <div class="modal-detail-value" id="modalViewRelatedTransactionValue"></div>
                    </div>

                    <h4 class="modal-detail-section-title">İşlem Geçmişi</h4>
                    <div class="modal-detail-item full-width task-history" id="modalViewTaskHistory">
                        <p style="text-align: center; color: #666;">İşlem geçmişi bulunmuyor.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="completeTaskModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeCompleteTaskModal">&times;</span>
            <h3 class="modal-title">İşi Tamamla ve Doküman Yükle</h3>
            <div class="modal-body-content">
                <p>Bu işi "Tamamlandı" olarak işaretlemek ve ilgili dokümanı yüklemek için aşağıdaki alanı kullanın.</p>
                <input type="hidden" id="completeTaskId">
                <input type="hidden" id="completeTaskRelatedIpRecordId">

                <div class="form-group">
                    <label class="form-label" for="completeTaskDocumentInput">Tamamlama Dokümanı (Opsiyonel)</label>
                    <div class="file-upload-area-modal" id="completeTaskFileUploadArea">
                        <div class="upload-icon">📄</div>
                        <div>Dosyayı buraya sürükleyin veya tıklayın</div>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">PDF, DOC, JPG, PNG formatları (Maks. 10MB)</div>
                        <input type="file" id="completeTaskDocumentInput" multiple hidden accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                    </div>
                    <div class="file-list-modal" id="completeTaskFileList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelCompleteTaskBtn">İptal</button>
                <button type="button" class="btn btn-primary" id="submitCompleteTaskBtn">İşi Tamamla</button>
            </div>
        </div>
    </div>

    <div class="modal" id="ipRecordDetailModal">
        <div class="modal-content portfolio-detail">
            <div class="modal-header">
                <h3 class="modal-title" id="ipRecordModalTitle">Kayıt Detayları</h3>
                <button class="close-modal-btn" id="closeIpRecordModalBtn">&times;</button>
            </div>
            <div id="ipRecordModalBody">
                </div>
            <h4 class="modal-detail-section-title" style="margin-top: 30px;">Belge İşlem Geçmişi</h4>
            <div class="task-history" id="ipRecordTransactionHistory">
                <p style="text-align: center; color: #666;">Yükleniyor...</p>
            </div>
        </div>
    </div>


    <script type="module">
        import { authService, taskService, ipRecordsService, personsService, auth, generateUUID } from './firebase-config.js';

        class MyTasksModule {
            constructor() {
                this.currentUser = null;
                this.tasks = [];
                this.allIpRecords = [];
                this.allPersons = [];
                this.uploadedCompletionFiles = []; // Yeni eklendi: İş tamamlama için yüklenen dosyalar
                this.init();
            }

            init() {
                authService.auth.onAuthStateChanged(async user => {
                    if (user) {
                        this.currentUser = authService.getCurrentUser();
                        this.updateUserInfo();
                        await this.loadInitialData();
                        this.setupEventListeners();
                    } else {
                        window.location.href = 'index.html';
                    }
                });
            }

            updateUserInfo() {
                if (this.currentUser) {
                    const userName = this.currentUser.displayName || this.currentUser.email.split('@')[0] || 'Kullanıcı';
                    const userRole = this.currentUser.role === 'admin' ? 'Yönetici' : this.currentUser.role === 'superadmin' ? 'Süper Yönetici' : 'Kullanıcı';
                    
                    document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
                    document.getElementById('userName').textContent = userName;
                    document.getElementById('userRole').textContent = userRole;
                }
            }
            
            async loadInitialData() {
                document.getElementById('loadingIndicator').style.display = 'block';
                try {
                    const [tasksResult, ipRecordsResult, personsResult] = await Promise.all([
                        taskService.getTasksForUser(this.currentUser.uid),
                        ipRecordsService.getRecords(),
                        personsService.getPersons()
                    ]);

                    if (tasksResult.success) {
                        this.tasks = tasksResult.data;
                    } else {
                        console.error('İşler yüklenirken hata:', tasksResult.error);
                    }
                    if (ipRecordsResult.success) {
                        this.allIpRecords = ipRecordsResult.data;
                    } else {
                        console.error('IP Kayıtları yüklenirken hata:', ipRecordsResult.error);
                    }
                    if (personsResult.success) {
                        this.allPersons = personsResult.data;
                    } else {
                        console.error('Kişiler yüklenirken hata:', personsResult.error);
                    }
                    this.renderTasks();

                } catch (error) {
                    console.error('Başlangıç verileri yüklenirken hata:', error);
                    alert('Veriler yüklenirken bir hata oluştu: ' + error.message);
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            setupEventListeners() {
                document.getElementById('logoutBtn').addEventListener('click', () => authService.signOut().then(() => window.location.href = 'index.html'));
                document.getElementById('statusFilter').addEventListener('change', (e) => this.renderTasks(e.target.value));

                // İş Detayı Modalı kapatma
                document.getElementById('closeViewTaskDetailModal').addEventListener('click', () => this.closeModal('viewTaskDetailModal'));
                document.getElementById('viewTaskDetailModal').addEventListener('click', (e) => {
                    if (e.target.id === 'viewTaskDetailModal') {
                        this.closeModal('viewTaskDetailModal');
                    }
                });

                // İş Tamamlama Modalı olay dinleyicileri
                document.getElementById('closeCompleteTaskModal').addEventListener('click', () => this.closeModal('completeTaskModal'));
                document.getElementById('cancelCompleteTaskBtn').addEventListener('click', () => this.closeModal('completeTaskModal'));
                document.getElementById('submitCompleteTaskBtn').addEventListener('click', () => this.handleCompleteTaskSubmit());
                document.getElementById('completeTaskDocumentInput').addEventListener('change', (e) => this.handleDocumentUploadForTaskCompletion(e.target.files));
                document.getElementById('completeTaskFileUploadArea').addEventListener('click', () => document.getElementById('completeTaskDocumentInput').click());
                
                // Drag & Drop için
                const completeTaskFileUploadArea = document.getElementById('completeTaskFileUploadArea');
                completeTaskFileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); completeTaskFileUploadArea.style.borderColor = '#1e3c72'; completeTaskFileUploadArea.style.background = '#f0f4f8'; });
                completeTaskFileUploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); completeTaskFileUploadArea.style.borderColor = '#e1e8ed'; completeTaskFileUploadArea.style.background = 'transparent'; });
                completeTaskFileUploadArea.addEventListener('drop', (e) => { e.preventDefault(); completeTaskFileUploadArea.style.borderColor = '#e1e8ed'; completeTaskFileUploadArea.style.background = 'transparent'; this.handleDocumentUploadForTaskCompletion(e.dataTransfer.files); });

                // Portföy Detay Modalı olay dinleyicileri (yeni)
                document.getElementById('closeIpRecordModalBtn').addEventListener('click', () => this.closeModal('ipRecordDetailModal'));
                document.getElementById('ipRecordDetailModal').addEventListener('click', (e) => {
                    if (e.target.id === 'ipRecordDetailModal') {
                        this.closeModal('ipRecordDetailModal');
                    }
                });
            }

            renderTasks(filter = 'all') {
                const tableBody = document.getElementById('tasksTableBody');
                const noTasksMessage = document.getElementById('noTasksMessage');
                tableBody.innerHTML = '';

                const filteredTasks = this.tasks.filter(task => {
                    if (filter === 'all') return true;
                    return task.status === filter;
                });
                
                if (filteredTasks.length === 0) {
                    noTasksMessage.style.display = 'block';
                    return;
                }
                noTasksMessage.style.display = 'none';

                const priorityMap = { high: 'Yüksek', medium: 'Orta', low: 'Düşük' };
                const statusMap = { open: 'Açık', in_progress: 'Devam Ediyor', completed: 'Tamamlandı', pending_review: 'Gözden Geçiriliyor' };

                filteredTasks.forEach(task => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="priority-${task.priority}">${priorityMap[task.priority] || 'Normal'}</span></td>
                        <td>${task.title}</td>
                        <td><a href="#" class="ip-record-link" data-ip-record-id="${task.relatedIpRecordId}" data-task-id="${task.id}">${task.relatedIpRecordTitle || '-'}</a></td> <td>${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : '-'}</td>
                        <td><span class="status-badge status-${task.status}">${statusMap[task.status] || task.status}</span></td>
                        <td>
                            <button class="action-btn view-btn" data-id="${task.id}">Görüntüle</button>
                            <button class="action-btn edit-btn" data-id="${task.id}">Güncelle</button>
                            <button class="action-btn delete-btn" data-id="${task.id}">Sil</button>
                            <button class="action-btn complete-btn" data-id="${task.id}" data-ip-record-id="${task.relatedIpRecordId}" ${task.status === 'completed' ? 'disabled' : ''}>İşi Bitir</button> </td>
                    `;
                    // Olay dinleyicilerini ekle
                    row.querySelector('.view-btn').addEventListener('click', () => this.viewTaskDetailsModal(task.id));
                    row.querySelector('.edit-btn').addEventListener('click', () => this.editTask(task.id));
                    row.querySelector('.delete-btn').addEventListener('click', () => this.deleteTask(task.id));
                    row.querySelector('.complete-btn').addEventListener('click', () => this.showCompleteTaskModal(task.id, task.relatedIpRecordId));
                    
                    // IP Kayıt linki için olay dinleyicisi
                    row.querySelector('.ip-record-link').addEventListener('click', (e) => {
                        e.preventDefault(); // Varsayılan sayfa geçişini engelle
                        this.showIpRecordDetailModal(e.currentTarget.dataset.ipRecordId); // Yeni fonksiyon
                    });

                    tableBody.appendChild(row);
                });
            }
            
            editTask(taskId) {
                // İş Detayları sayfasına yönlendir (düzenlenebilir modda)
                window.location.href = `task-detail.html?taskId=${taskId}&mode=edit`;
            }

            async deleteTask(taskId) {
                if (confirm('Bu görevi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
                    try {
                        const result = await taskService.deleteTask(taskId);
                        if (result.success) {
                            alert('Görev başarıyla silindi.');
                            await this.loadInitialData();
                        } else {
                            throw new Error(result.error);
                        }
                    } catch (error) {
                        console.error('Görev silinirken hata:', error);
                        alert('Görev silinirken bir hata oluştu: ' + error.message);
                    }
                }
            }

            async viewTaskDetailsModal(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) {
                    alert('Görev bulunamadı.');
                    return;
                }
                
                this.populateModalTaskDetails(task, this.allIpRecords, this.allPersons);
                document.getElementById('viewTaskDetailModal').classList.add('show');
            }

            populateModalTaskDetails(task, ipRecords, persons) {
                const modal = document.getElementById('viewTaskDetailModal');
                if (!modal) return;

                document.getElementById('modalViewTaskTitle').textContent = `İş Detayı: ${task.title || '-'}`;

                document.getElementById('modalViewTaskTitleValue').textContent = task.title || '-';
                document.getElementById('modalViewTaskDescriptionValue').textContent = task.description || '-';
                
                const taskTypeParts = task.taskType ? task.taskType.split('_') : [];
                const mainType = taskTypeParts[0] || '';
                const specificType = taskTypeParts.slice(1).join(' ').replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('modalViewTaskTypeValue').textContent = `${mainType.charAt(0).toUpperCase() + mainType.slice(1)} - ${specificType}` || '-';

                const priorityMap = { high: 'Yüksek', medium: 'Orta', low: 'Düşük' };
                document.getElementById('modalViewTaskPriorityValue').textContent = priorityMap[task.priority] || task.priority || '-';
                
                document.getElementById('modalViewAssignedToValue').textContent = task.assignedTo_email || '-';
                document.getElementById('modalViewTaskDueDateValue').textContent = task.dueDate ? new Date(task.dueDate).toLocaleDateString('tr-TR') : '-';

                let relatedIpRecordText = '-';
                if (task.relatedIpRecordId) {
                    const ipRecord = ipRecords.find(r => r.id === task.relatedIpRecordId);
                    if (ipRecord) {
                        relatedIpRecordText = `${ipRecord.title || ipRecord.applicationNumber || 'Kayıt'}`;
                    } else {
                        relatedIpRecordText = task.relatedIpRecordTitle || 'Kayıt Bulunamadı';
                    }
                }
                document.getElementById('modalViewRelatedIpRecordValue').textContent = relatedIpRecordText;

                const modalViewRelatedPartyGroup = document.getElementById('modalViewRelatedPartyGroup');
                const modalViewRelatedPartyLabel = document.getElementById('modalViewRelatedPartyLabel');
                const modalViewRelatedPartyValue = document.getElementById('modalViewRelatedPartyValue');
                if (task.details?.relatedParty?.id) {
                    const person = persons.find(p => p.id === task.details.relatedParty.id);
                    if (person) {
                        const taskType = task.taskType.split('_')[1];
                        const labelMap = { 'devir': 'Devralan Taraf', 'lisans': 'Lisans Alan Taraf', 'rehin': 'Rehin Alan Taraf', 'birleşme': 'Birleşilen Taraf', 'veraset': 'Mirasçı', 'teminat': 'Rehin Alan Taraf' };
                        modalViewRelatedPartyLabel.textContent = labelMap[taskType] || 'İlgili Taraf';
                        modalViewRelatedPartyValue.textContent = person.name;
                        modalViewRelatedPartyGroup.style.display = 'block';
                    } else {
                        modalViewRelatedPartyGroup.style.display = 'none';
                    }
                } else {
                    modalViewRelatedPartyGroup.style.display = 'none';
                }

                const modalViewRelatedTransactionGroup = document.getElementById('modalViewRelatedTransactionGroup');
                const modalViewRelatedTransactionLabel = document.getElementById('modalViewRelatedTransactionLabel');
                const modalViewRelatedTransactionValue = document.getElementById('modalViewRelatedTransactionValue');
                if (task.details?.relatedTransactionId && task.relatedIpRecordId) {
                    const ipRecord = ipRecords.find(r => r.id === task.relatedIpRecordId);
                    if (ipRecord && ipRecord.transactions) {
                        const transaction = ipRecord.transactions.find(tx => tx.transactionId === task.details.relatedTransactionId);
                        if (transaction) {
                            modalViewRelatedTransactionLabel.textContent = 'İlgili Üst İşlem';
                            modalViewRelatedTransactionValue.textContent = transaction.description || transaction.type;
                            modalViewRelatedTransactionGroup.style.display = 'block';
                        } else {
                            modalViewRelatedTransactionGroup.style.display = 'none';
                        }
                    } else {
                        modalViewRelatedTransactionGroup.style.display = 'none';
                    }
                } else {
                    modalViewRelatedTransactionGroup.style.display = 'none';
                }

                const modalViewTaskHistory = document.getElementById('modalViewTaskHistory');
                modalViewTaskHistory.innerHTML = '';
                if (!task.history || task.history.length === 0) {
                    modalViewTaskHistory.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">İşlem geçmişi bulunmuyor.</p>';
                } else {
                    const sortedHistory = [...task.history].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    sortedHistory.forEach(entry => {
                        const item = document.createElement('div');
                        item.className = 'task-history-item';
                        item.innerHTML = `
                            <div class="task-history-item-content">
                                <div class="task-history-info">
                                    <div class="task-history-description">${entry.action}</div>
                                    <div class="task-history-meta">${new Date(entry.timestamp).toLocaleString('tr-TR')} by ${entry.userEmail}</div>
                                </div>
                            </div>
                        `;
                        modalViewTaskHistory.appendChild(item);
                    });
                }
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('show');
                this.uploadedCompletionFiles = []; // Modalı kapatırken yüklenen dosyaları temizle
                document.getElementById('completeTaskFileList').innerHTML = ''; // Dosya listesini temizle
            }

            // --- Yeni İş Tamamlama ve Doküman Yükleme Metodları ---
            showCompleteTaskModal(taskId, relatedIpRecordId) {
                document.getElementById('completeTaskId').value = taskId;
                document.getElementById('completeTaskRelatedIpRecordId').value = relatedIpRecordId;
                this.uploadedCompletionFiles = []; // Her açılışta dosyaları sıfırla
                document.getElementById('completeTaskFileList').innerHTML = '';
                document.getElementById('completeTaskModal').classList.add('show');
            }

            handleDocumentUploadForTaskCompletion(files) {
                for (const file of files) {
                    if (file.size > 10 * 1024 * 1024) { // 10MB limit
                        alert(`"${file.name}" dosyası 10MB'tan büyük ve yüklenemedi.`);
                        continue;
                    }
                    if (this.uploadedCompletionFiles.some(f => f.name === file.name && f.size === file.size)) {
                        alert(`"${file.name}" dosyası zaten eklenmiş.`);
                        continue;
                    }

                    this.readFileAsDataURL(file).then(dataUrl => {
                        this.uploadedCompletionFiles.push({
                            id: generateUUID(),
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            content: dataUrl,
                            uploadedAt: new Date().toISOString(),
                            documentDesignation: 'İş Tamamlama Dokümanı', // Varsayılan atama
                            subDesignation: null,
                            parentTransactionId: null // Bu bir ana doküman olmalı, task tamamlama özelinde
                        });
                        this.renderDocumentListForTaskCompletion();
                    }).catch(error => {
                        console.error("Dosya okuma hatası:", error);
                        alert(`"${file.name}" dosyası okunamadı.`);
                    });
                }
            }

            renderDocumentListForTaskCompletion() {
                const fileList = document.getElementById('completeTaskFileList');
                fileList.innerHTML = '';
                this.uploadedCompletionFiles.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item-modal';
                    fileItem.innerHTML = `
                        <span>${file.name} (${this.formatFileSize(file.size)})</span>
                        <button type="button" class="remove-file-modal" data-id="${file.id}">&times;</button>
                    `;
                    fileItem.querySelector('.remove-file-modal').addEventListener('click', () => {
                        this.uploadedCompletionFiles = this.uploadedCompletionFiles.filter(f => f.id !== file.id);
                        this.renderDocumentListForTaskCompletion();
                    });
                    fileList.appendChild(fileItem);
                });
            }

            async handleCompleteTaskSubmit() {
                const taskId = document.getElementById('completeTaskId').value;
                const relatedIpRecordId = document.getElementById('completeTaskRelatedIpRecordId').value;

                if (!taskId) {
                    alert('İş ID\'si bulunamadı.');
                    return;
                }

                if (confirm('Bu işi "Tamamlandı" olarak işaretlemek ve seçili dokümanları yüklemek istediğinizden emin misiniz?')) {
                    try {
                        // 1. İşin durumunu güncelle
                        const taskUpdateResult = await taskService.updateTask(taskId, { status: 'completed' });
                        if (!taskUpdateResult.success) {
                            throw new Error(taskUpdateResult.error || 'İş durumu güncellenemedi.');
                        }

                        // 2. Eğer doküman varsa, portföy kaydına ekle
                        if (this.uploadedCompletionFiles.length > 0 && relatedIpRecordId) {
                            const filesToUpload = this.uploadedCompletionFiles.map(file => ({
                                id: file.id, // Dokümanın kendi ID'si
                                name: file.name,
                                type: file.type,
                                content: file.content,
                                uploadedAt: file.uploadedAt,
                                documentDesignation: 'İş Tamamlama Dokümanı', // Varsayılan atama
                                subDesignation: null,
                                parentTransactionId: null, // Bu bir ana doküman olmalı, task tamamlama özelinde
                                indexingType: 'İş Tamamlama', // İş tamamlama dokümanı olarak işaretle
                                indexingName: `İş Tamamlama Dokümanı: ${file.name}`
                            }));

                            const ipRecordUpdateResult = await ipRecordsService.updateRecord(relatedIpRecordId, {
                                files: filesToUpload // Bu, mevcut dosyalara ekleme yapacaktır
                            });

                            if (!ipRecordUpdateResult.success) {
                                // Doküman yüklenirken hata oluşursa, iş durumu güncellense bile kullanıcıya bildir
                                alert('İş durumu güncellendi ancak dokümanlar yüklenirken bir hata oluştu: ' + (ipRecordUpdateResult.error || 'Bilinmeyen hata.'));
                            } else {
                                alert('İş başarıyla tamamlandı ve dokümanlar yüklendi!');
                            }
                        } else {
                            alert('İş başarıyla tamamlandı!');
                        }

                        this.closeModal('completeTaskModal');
                        await this.loadInitialData(); // Listeyi yeniden yükle
                    } catch (error) {
                        console.error('İş tamamlama hatası:', error);
                        alert('İş tamamlanırken bir hata oluştu: ' + error.message);
                    }
                }
            }

            readFileAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // --- Portföy Detayı Modalı İçin Fonksiyonlar ---
            async showIpRecordDetailModal(recordId) {
                const record = this.allIpRecords.find(r => r.id === recordId);
                if (!record) {
                    alert('Portföy kaydı bulunamadı.');
                    return;
                }

                const modal = document.getElementById('ipRecordDetailModal');
                if (!modal) {
                    console.error('IP Record Detail Modal element not found!');
                    return;
                }

                const typeNames = { patent: 'Patent', trademark: 'Marka', copyright: 'Telif Hakkı', design: 'Tasarım' };
                const statusNames = { application: 'Başvuru', pending: 'Beklemede', approved: 'Onaylandı', rejected: 'Reddedildi', expired: 'Süresi Doldu', published: 'Yayınlandı', partial_refusal: 'Kısmi Ret', refused: 'Ret', opposition_received: 'İtiraz Geldi', opposition_filed: 'İtiraz Edildi', registered: 'Tescilli', not_renewed: 'Yenilenmedi', invalid_void: 'Geçersiz' };

                const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('tr-TR') : '-';
                const renderField = (label, value, isLongText = false) => {
                    if (value === null || value === undefined || value === '') return '';
                    if (isLongText) {
                        return `<div class="modal-detail-item full-width"><div class="modal-detail-label">${label}</div><div class="modal-detail-value long-text">${value}</div></div>`;
                    }
                    return `<div class="modal-detail-item"><div class="modal-detail-label">${label}</div><div class="modal-detail-value">${value}</div></div>`;
                };

                document.getElementById('ipRecordModalTitle').textContent = `Detay: ${record.title}`;
                let modalContentHtml = `<div class="modal-detail-grid portfolio-detail">`;
                
                modalContentHtml += `<h4 class="modal-detail-section-title">Genel Bilgiler</h4>`;
                modalContentHtml += renderField('Tür', `<span class="ip-type ${record.type}">${typeNames[record.type] || 'Bilinmiyor'}</span>`);
                modalContentHtml += renderField('Başlık', record.title);
                modalContentHtml += renderField('Durum', `<span class="status-badge ${record.status}">${statusNames[record.status] || record.status}</span>`);
                modalContentHtml += renderField('Başvuru Numarası', record.applicationNumber);
                modalContentHtml += renderField('Tescil Numarası', record.registrationNumber);
                modalContentHtml += renderField('Başvuru Tarihi', formatDate(record.applicationDate));
                modalContentHtml += renderField('Tescil Tarihi', formatDate(record.registrationDate));
                modalContentHtml += renderField('Hak Sahipleri', (record.owners || []).map(o => o.name).join(', '));
                if(this.currentUser && this.currentUser.role === 'superadmin') {
                    modalContentHtml += renderField('Oluşturan Kullanıcı', record.userEmail);
                }

                if (record.type === 'patent') {
                    modalContentHtml += `<h4 class="modal-detail-section-title">Patent Detayları</h4>`;
                    modalContentHtml += renderField('Patent Sınıfı', record.patentClass);
                    modalContentHtml += renderField('Öncelik Tarihi', formatDate(record.priority));
                    modalContentHtml += renderField('Son Geçerlilik Tarihi', formatDate(record.expiryDate));
                    modalContentHtml += renderField('Patent İstekleri (Claims)', record.claims, true);
                }
                if (record.type === 'trademark') {
                    modalContentHtml += `<h4 class="modal-detail-section-title">Marka Detayları</h4>`;
                    if (record.trademarkImage && record.trademarkImage.content) {
                        modalContentHtml += `
                            <div class="modal-detail-item full-width" style="text-align: center; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
                                <div class="modal-detail-label">Marka Örneği</div>
                                <img src="${record.trademarkImage.content}" style="max-width: 200px; max-height: 200px; border: 1px solid #e1e8ed; border-radius: 8px;" alt="Marka Örneği">
                            </div>`;
                    }
                    modalContentHtml += renderField('Marka Türü', record.trademarkType);
                    modalContentHtml += renderField('Nice Sınıfı', record.niceClass);
                    modalContentHtml += renderField('Yenileme Tarihi', formatDate(record.renewalDate));
                    modalContentHtml += renderField('Bülten Tarihi', formatDate(record.bulletinDate));
                    modalContentHtml += renderField('Bülten Numarası', record.bulletinNumber);
                    modalContentHtml += renderField('Mal ve Hizmetler', record.goodsServices, true);
                }
                if (record.type === 'copyright') {
                    modalContentHtml += `<h4 class="modal-detail-section-title">Telif Hakkı Detayları</h4>`;
                    modalContentHtml += renderField('Eser Türü', record.workType);
                    modalContentHtml += renderField('Oluşturulma Tarihi', formatDate(record.creationDate));
                    modalContentHtml += renderField('Yayın Tarihi', formatDate(record.publicationDate));
                    modalContentHtml += renderField('Yayımcı/Yapımcı', record.publisher);
                }
                if (record.type === 'design') {
                    modalContentHtml += `<h4 class="modal-detail-section-title">Tasarım Detayları</h4>`;
                    modalContentHtml += renderField('Tasarım Türü', record.designType);
                    modalContentHtml += renderField('Locarno Sınıfı', record.locarnoClass);
                    modalContentHtml += renderField('Tasarım Tarihi', formatDate(record.designDate));
                    modalContentHtml += renderField('Tasarım Özellikleri', record.designFeatures, true);
                }
                
                modalContentHtml += `<h4 class="modal-detail-section-title">Açıklama</h4>`;
                modalContentHtml += renderField('Açıklama', record.description, true);

                // Portföy detay modalında dokümanları görüntüleme
                if (record.files && record.files.length > 0) {
                    modalContentHtml += `<h4 class="modal-detail-section-title">Yüklenen Dokümanlar</h4>`;
                    modalContentHtml += `<div class="modal-detail-item full-width"><ul>`;
                    record.files.forEach(file => {
                        modalContentHtml += `<li><a href="${file.content}" download="${file.name}">📄 ${file.name} (${this.formatFileSize(file.size)}) - ${file.documentDesignation || 'Belge'}</a></li>`;
                    });
                    modalContentHtml += `</ul></div>`;
                }
                
                modalContentHtml += `</div>`; // .modal-detail-grid kapanışı
                
                document.getElementById('ipRecordModalBody').innerHTML = modalContentHtml;

                // Transaction geçmişi (sadece görüntüleme, düzenleme/silme butonları yok)
                this.renderIpRecordTransactionHistory(record.id, record.transactions, record.files);
                
                modal.classList.add('show');
            }

            renderIpRecordTransactionHistory(recordId, transactions, recordFiles) {
                const historyContainer = document.getElementById('ipRecordTransactionHistory');
                historyContainer.innerHTML = '';

                if (!transactions || transactions.length === 0) {
                    historyContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Belge işlem geçmişi bulunmuyor.</p>';
                    return;
                }

                const allTransactions = transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                const displayableTransactionTypes = [
                    "Document Indexed", "Document Sub-Indexed",
                    'Başvuru', 'İtiraza Karşı Görüş (YIDD)', 'Yenileme', 'Eksiklik Giderme', 'Yayına İtiraz',
                    'Karara İtiraz', 'Yayıma İtirazın Yeniden İncelenmesi', 'İtiraza Karşı Görüş (Markalar)',
                    'Devir', 'Lisans', 'Birleşme', 'Veraset ile İntikal', 'Tescil Belgesi Sureti',
                    'Sicil Sureti', 'Menşe Memleket Belgesi', 'Rehin/Teminat', 'Bölünme', 'Vazgeçme',
                    'Tanınmışlık Tespiti', '3.Kişi Görüşü', 'Yayına İtirazı Geri Çekme',
                    'Madrid Başvurusu Ücret Ödeme', 'Muvaffakat Sunumu', 'Kullanım İspatı Sunma',
                    'İtiraza Ek Belge', 'Eşya Sınırlandırma',
                    'Kabul Kararı', 'Ret Kararı', 'İş Tamamlama',
                    'Eksiklik Bildirimi'
                ];

                const relevantTransactions = allTransactions.filter(tx => 
                    displayableTransactionTypes.includes(tx.type) || displayableTransactionTypes.includes(tx.description)
                ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));


                if (relevantTransactions.length === 0) {
                    historyContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Gösterilebilir işlem bulunmuyor.</p>';
                    return;
                }

                const transactionsMap = new Map(relevantTransactions.map(tx => [tx.transactionId, tx]));
                const childrenMap = new Map();
                
                relevantTransactions.forEach(tx => {
                    if (tx.parentId && transactionsMap.has(tx.parentId)) {
                        if (!childrenMap.has(tx.parentId)) childrenMap.set(tx.parentId, []);
                        childrenMap.get(tx.parentId).push(tx);
                    }
                });

                const buildTreeHtml = (transactionsToBuild) => {
                    let html = '';
                    transactionsToBuild.forEach(tx => {
                        const children = childrenMap.get(tx.transactionId) || [];
                        const hasChildren = children.length > 0;
                        let documentLinkHtml = '';
                        if (tx.documentId && recordFiles) {
                            const relatedFile = recordFiles.find(file => file.id === tx.documentId);
                            if (relatedFile) documentLinkHtml = ` | <a href="${relatedFile.content}" download="${relatedFile.name}" class="transaction-document-link">📄 Belge</a>`;
                        }
                        html += `
                            <div class="transaction-node" data-id="${tx.transactionId}">
                                ${hasChildren ? `<button class="transaction-toggle-btn" data-target-id="${tx.transactionId}">${children.length > 0 ? '+' : ''}</button>` : ''}
                                <div class="transaction-node-content">
                                    <div class="transaction-info">
                                        <div class="transaction-description">${tx.description || tx.type}</div> 
                                        <div class="transaction-meta">${new Date(tx.timestamp).toLocaleDateString('tr-TR')} by ${tx.userEmail}${documentLinkHtml}</div>
                                    </div>
                                    </div>
                            </div>
                            ${hasChildren ? `<div class="child-transactions" id="children-of-${tx.transactionId}">${buildTreeHtml(children)}</div>` : ''}`;
                    });
                    return html;
                };

                const rootTransactions = relevantTransactions.filter(tx => !tx.parentId || !transactionsMap.has(tx.parentId));
                historyContainer.innerHTML = buildTreeHtml(rootTransactions);

                // Akordiyon düğmelerine olay dinleyici ekle
                historyContainer.querySelectorAll('.transaction-toggle-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetId = btn.dataset.targetId;
                        const childContainer = document.getElementById(`children-of-${targetId}`);
                        if (childContainer) {
                            childContainer.classList.toggle('show');
                            btn.classList.toggle('expanded');
                            btn.textContent = childContainer.classList.contains('show') ? '−' : '+';
                        }
                    });
                });

                if (rootTransactions.length === 0) {
                    historyContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Gösterilebilir işlem bulunmuyor.</p>';
                }
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('show');
            }

            exportData() {
                if (this.filteredRecords.length === 0) {
                    alert('Dışa aktarılacak kayıt bulunamadı.');
                    return;
                }

                const headers = ["Tür", "Başlık", "Başvuru Numarası", "Durum", "Başvuru Tarihi", "Tescil Tarihi", "Hak Sahipleri", "Açıklama"];
                const data = this.filteredRecords.map(record => {
                    const owners = (record.owners || []).map(o => o.name).join(', ');
                    const applicationDate = record.applicationDate ? new Date(record.applicationDate).toLocaleDateString('tr-TR') : '';
                    const registrationDate = record.registrationDate ? new Date(record.registrationDate).toLocaleDateString('tr-TR') : '';
                    return [
                        record.type || '',
                        `"${record.title}"` || '', // Başlık içinde virgül olabileceği için tırnak içine al
                        record.applicationNumber || '',
                        record.status || '',
                        applicationDate,
                        registrationDate,
                        `"${owners}"` || '',
                        `"${record.description || ''}"` // Açıklama içinde virgül olabileceği için tırnak içine al
                    ];
                });

                let csvContent = "data:text/csv;charset=utf-8,\uFEFF" // UTF-8 BOM ekleme
                csvContent += headers.join(';') + '\r\n'; // Başlıkları noktalı virgülle ayır
                data.forEach(row => {
                    csvContent += row.join(';') + '\r\n'; // Satırları noktalı virgülle ayır
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "fikri_mulkiyet_portfoyu.csv");
                document.body.appendChild(link); // Required for Firefox
                link.click();
                document.body.removeChild(link);
            }

            showEmptyState() {
                document.getElementById('portfolioTable').style.display = 'none';
                document.getElementById('pagination').style.display = 'none';
                document.getElementById('noRecords').style.display = 'block';
            }
        }

        // Modülün global scope'ta tanımlanması
        window.portfolio = new PortfolioModule();

        // YENİ AKORDİYON MENÜ İÇİN JAVASCRIPT
        document.addEventListener('DOMContentLoaded', function() {
    // --- Akordiyon Menü Tıklama Fonksiyonu ---
    const accordions = document.querySelectorAll('.accordion-header');
    accordions.forEach(accordion => {
        accordion.addEventListener('click', function(event) {
            // Akordiyonu aç/kapat
            this.classList.toggle('active');
            const content = this.nextElementSibling;
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        });
    });

    // --- Sayfa Yüklendiğinde Aktif Menüyü Ayarlama Fonksiyonu ---
    function setActiveMenu() {
        const currentPage = window.location.pathname.split("/").pop() || 'dashboard.html';
        
        // Önce tüm aktif işaretlerini temizle
        document.querySelectorAll('.sidebar-nav-item.active, .accordion-content a.active').forEach(el => el.classList.remove('active'));
        
        // Mevcut sayfanın linkini bul ve aktif yap
        const activeLink = document.querySelector(`.sidebar-nav a[href="${currentPage}"]`);
        if (!activeLink) return;

        activeLink.classList.add('active');
        
        // Eğer link bir akordiyon içindeyse, akordiyonu aç ve başlığını aktif et
        const parentAccordionContent = activeLink.closest('.accordion-content');
        if (parentAccordionContent) {
            const parentAccordionHeader = parentAccordionContent.previousElementSibling;
            if (parentAccordionHeader && parentAccordionHeader.classList.contains('accordion-header')) {
                parentAccordionHeader.classList.add('active');
                parentAccordionContent.style.maxHeight = parentAccordionContent.scrollHeight + "px";
            }
        }
    }

    // Sayfa ilk yüklendiğinde aktif menüyü ayarla
    setActiveMenu();
});
    </script>
</body>
</html>