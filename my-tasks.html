<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - İşlerim</title>
    <style>
        /* CSS styles are unchanged, they are correct */
    </style>
</head>
<body>
    <aside class="sidebar">
        </aside>

    <div class="page-wrapper">
        <header class="top-header">
            </header>

        <main class="main-container">
            <section class="page-header">
                <h1 class="page-title">Bana Atanan İşler</h1>
                <p class="page-subtitle">Size atanmış olan tüm görevleri buradan takip edebilirsiniz.</p>
            </section>
    
            <div class="tasks-container">
                <div class="tasks-header">
                    <div class="filter-group">
                        <label class="filter-label" for="statusFilter">Duruma Göre Filtrele:</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="all">Tümü</option>
                            <option value="open">Açık</option>
                            <option value="in_progress">Devam Ediyor</option>
                            <option value="pending_review">Gözden Geçiriliyor</option>
                            <option value="completed">Tamamlandı</option>
                        </select>
                    </div>
                    <button id="assignSelectedBtn" class="btn-secondary" disabled>Seçilenleri Başka Kullanıcıya Ata</button>
                </div>
                <div class="table-container">
                    <table class="task-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox" title="Tümünü Seç"></th>
                                <th>Öncelik</th>
                                <th>İş Başlığı</th>
                                <th>İlgili Kayıt</th>
                                <th>Bitiş Tarihi</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody"></tbody>
                    </table>
                     <div id="loadingIndicator" class="loading">Yükleniyor...</div>
                     <div id="noTasksMessage" class="no-tasks">Size atanmış aktif bir iş bulunmamaktadır.</div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { authService, taskService, ipRecordsService, personsService, auth, generateUUID } from './firebase-config.js';

        class MyTasksModule {
            constructor() {
                // ... properties
            }

            async init() {
                // ... init logic
            }
            
            // ... other methods ...

            renderTasks(filter = 'all') {
                const tableBody = document.getElementById('tasksTableBody');
                const noTasksMessage = document.getElementById('noTasksMessage');
                tableBody.innerHTML = '';
                const filteredTasks = this.tasks.filter(task => filter === 'all' || task.status === filter);
                if (filteredTasks.length === 0) {
                    noTasksMessage.style.display = 'block';
                    return;
                }
                noTasksMessage.style.display = 'none'; 
                const priorityMap = { high: 'Yüksek', medium: 'Orta', low: 'Düşük' };
                const statusMap = { open: 'Açık', in_progress: 'Devam Ediyor', completed: 'Tamamlandı', pending_review: 'Gözden Geçiriliyor' };
                
                filteredTasks.forEach(task => {
                    const row = document.createElement('tr');
                    const relatedIpRecordTitle = task.relatedIpRecordTitle || '-'; 
                    const relatedIpRecordId = task.relatedIpRecordId || '';
                    row.innerHTML = `
                        <td><input type="checkbox" class="task-checkbox" data-id="${task.id}" ${task.status === 'completed' ? 'disabled' : ''}></td>
                        <td><span class="priority-${task.priority}">${priorityMap[task.priority] || 'Normal'}</span></td>
                        <td>${task.title}</td>
                        <td><a href="#" class="ip-record-link" data-ip-record-id="${relatedIpRecordId}">${relatedIpRecordTitle}</a></td> 
                        <td>${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : '-'}</td>
                        <td><span class="status-badge status-${task.status}">${statusMap[task.status] || task.status}</span></td>
                        <td>
                            <button class="action-btn view-btn" data-id="${task.id}">Görüntüle</button>
                            <button class="action-btn edit-btn" data-id="${task.id}">Güncelle</button>
                            <button class="action-btn delete-btn" data-id="${task.id}">Sil</button>
                            <button class="action-btn complete-btn" data-id="${task.id}" data-ip-record-id="${task.relatedIpRecordId}" ${task.status === 'completed' ? 'disabled' : ''}>İşi Bitir</button> 
                        </td>
                    `;
                    
                    // DÜZELTME: Olay dinleyicileri burada ekleniyor
                    row.querySelector('.view-btn').addEventListener('click', () => this.viewTaskDetailsModal(task.id));
                    row.querySelector('.edit-btn').addEventListener('click', () => this.editTask(task.id));
                    row.querySelector('.delete-btn').addEventListener('click', () => this.deleteTask(task.id));
                    row.querySelector('.complete-btn').addEventListener('click', () => this.showCompleteTaskModal(task.id, task.relatedIpRecordId));
                    const ipRecordLink = row.querySelector('.ip-record-link');
                    if (ipRecordLink && relatedIpRecordId) {
                        ipRecordLink.addEventListener('click', (e) => { 
                            e.preventDefault(); 
                            this.showIpRecordDetailModal(relatedIpRecordId); 
                        });
                    }

                    tableBody.appendChild(row);
                });
                this.handleSelectionChange();
            }

            // ... other methods like assignment logic, etc.
        }

        // Initialization logic with DOMContentLoaded wrapper
        document.addEventListener('DOMContentLoaded', function() {
            // ... accordion and menu logic ...
            
            let myTasksModuleInstance;
            authService.auth.onAuthStateChanged((user) => {
                if (user || authService.getCurrentUser()) {
                    if (!myTasksModuleInstance) {
                        myTasksModuleInstance = new MyTasksModule();
                        myTasksModuleInstance.init();
                    }
                } else {
                    window.location.href = 'index.html';
                }
            });
        });
    </script>
</body>
</html>