<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - İşlerim</title>
    <style>
        /* CSS stilleri öncekiyle aynı, değişiklik yok */
    </style>
</head>
<body>
    <script type="module">
        import { authService, taskService, ipRecordsService, personsService, auth, generateUUID } from './firebase-config.js';

        class MyTasksModule {
            constructor() {
                // ... özellikler ...
            }

            async init() {
                this.currentUser = authService.getCurrentUser();
                if (!this.currentUser) {
                    window.location.href = 'index.html';
                    return;
                }
                
                this.updateUserInfo();
                this.setupEventListeners();
                await this.loadInitialData();
            }

            updateUserInfo() {
                if (this.currentUser) {
                    const userName = this.currentUser.displayName || this.currentUser.email.split('@')[0] || 'Kullanıcı';
                    const userRole = this.currentUser.role === 'admin' ? 'Yönetici' : this.currentUser.role === 'superadmin' ? 'Süper Yönetici' : 'Kullanıcı';
                    
                    const avatarEl = document.getElementById('userAvatar');
                    const nameEl = document.getElementById('userName');
                    const roleEl = document.getElementById('userRole');

                    // DÜZELTME: Elementlerin var olup olmadığını kontrol et
                    if (avatarEl && nameEl && roleEl) {
                        avatarEl.textContent = userName.charAt(0).toUpperCase();
                        nameEl.textContent = userName;
                        roleEl.textContent = userRole;
                    } else {
                        console.error("Hata: Kullanıcı bilgi elementleri DOM'da bulunamadı.");
                    }
                }
            }
            
            // ... (diğer tüm metodlar aynı kalacak) ...
        }

        // DÜZELTİLMİŞ BAŞLATMA KODU
        document.addEventListener('DOMContentLoaded', () => {
            // Önce sayfa içi UI elemanlarını ayarla
            const accordions = document.querySelectorAll('.accordion-header');
            accordions.forEach(accordion => { 
                accordion.addEventListener('click', function() { 
                    this.classList.toggle('active'); 
                    const content = this.nextElementSibling; 
                    if (content.style.maxHeight) { content.style.maxHeight = null; } 
                    else { content.style.maxHeight = content.scrollHeight + "px"; } 
                }); 
            });

            function setActiveMenu() { 
                const currentPage = window.location.pathname.split("/").pop() || 'dashboard.html'; 
                document.querySelectorAll('.sidebar-nav-item.active, .accordion-content a.active').forEach(el => el.classList.remove('active')); 
                const activeLink = document.querySelector(`.sidebar-nav a[href="${currentPage}"]`); 
                if (!activeLink) return; 
                activeLink.classList.add('active'); 
                const parentAccordionContent = activeLink.closest('.accordion-content'); 
                if (parentAccordionContent) { 
                    const parentAccordionHeader = parentAccordionContent.previousElementSibling; 
                    if (parentAccordionHeader && parentAccordionHeader.classList.contains('accordion-header')) { 
                        parentAccordionHeader.classList.add('active'); 
                        parentAccordionContent.style.maxHeight = parentAccordionContent.scrollHeight + "px"; 
                    } 
                } 
            }
            setActiveMenu();

            // DOM yüklendikten sonra auth durumunu dinle ve modülü başlat
            let myTasksModuleInstance;
            authService.auth.onAuthStateChanged(async (user) => {
                if (user) {
                    if (!myTasksModuleInstance) {
                        myTasksModuleInstance = new MyTasksModule();
                        await myTasksModuleInstance.init();
                    }
                } else {
                    window.location.href = 'index.html';
                }
            });
        });
    </script>
</body>
</html>